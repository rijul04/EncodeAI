var vn=Object.create;var lt=Object.defineProperty;var An=Object.getOwnPropertyDescriptor;var wn=Object.getOwnPropertyNames;var Sn=Object.getPrototypeOf,Rn=Object.prototype.hasOwnProperty;var pt=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var kn=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var _n=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of wn(t))!Rn.call(e,r)&&r!==n&&lt(e,r,{get:()=>t[r],enumerable:!(o=An(t,r))||o.enumerable});return e};var Pn=(e,t,n)=>(n=e!=null?vn(Sn(e)):{},_n(t||!e||!e.__esModule?lt(n,"default",{value:e,enumerable:!0}):n,e));var Vt=kn((fs,se)=>{"use strict";var Wn=typeof Buffer<"u",qt=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,Wt=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function Ft(e,t,n){n==null&&t!==null&&typeof t=="object"&&(n=t,t=void 0),Wn&&Buffer.isBuffer(e)&&(e=e.toString()),e&&e.charCodeAt(0)===65279&&(e=e.slice(1));let o=JSON.parse(e,t);if(o===null||typeof o!="object")return o;let r=n&&n.protoAction||"error",a=n&&n.constructorAction||"error";if(r==="ignore"&&a==="ignore")return o;if(r!=="ignore"&&a!=="ignore"){if(qt.test(e)===!1&&Wt.test(e)===!1)return o}else if(r!=="ignore"&&a==="ignore"){if(qt.test(e)===!1)return o}else if(Wt.test(e)===!1)return o;return Zt(o,{protoAction:r,constructorAction:a,safe:n&&n.safe})}function Zt(e,{protoAction:t="error",constructorAction:n="error",safe:o}={}){let r=[e];for(;r.length;){let a=r;r=[];for(let s of a){if(t!=="ignore"&&Object.prototype.hasOwnProperty.call(s,"__proto__")){if(o===!0)return null;if(t==="error")throw new SyntaxError("Object contains forbidden prototype property");delete s.__proto__}if(n!=="ignore"&&Object.prototype.hasOwnProperty.call(s,"constructor")&&Object.prototype.hasOwnProperty.call(s.constructor,"prototype")){if(o===!0)return null;if(n==="error")throw new SyntaxError("Object contains forbidden prototype property");delete s.constructor}for(let i in s){let c=s[i];c&&typeof c=="object"&&r.push(c)}}}return e}function He(e,t,n){let o=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return Ft(e,t,n)}finally{Error.stackTraceLimit=o}}function Fn(e,t){let n=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return Ft(e,t,{safe:!0})}catch{return null}finally{Error.stackTraceLimit=n}}se.exports=He;se.exports.default=He;se.exports.parse=He;se.exports.safeParse=Fn;se.exports.scan=Zt});import{z as fn}from"zod";import"ai";import"zod";import{}from"ai";var me=(a=>(a[a.ERROR=0]="ERROR",a[a.WARN=1]="WARN",a[a.INFO=2]="INFO",a[a.DEBUG=3]="DEBUG",a[a.TRACE=4]="TRACE",a))(me||{});var ge=class{config;logWriter;constructor(t){if(this.config={level:t.level,enableTimestamp:t.enableTimestamp??!0,enableColors:t.enableColors??!0,logToFile:t.logToFile??!1,logPath:t.logPath??"./logs"},this.config.logToFile&&!t.logWriter)throw new Error("LogWriter must be provided when logToFile is enabled");t.logWriter&&(this.logWriter=t.logWriter)}error(t,n,o){this.log(0,t,n,o),o&&console.error(o)}warn(t,n,o){this.log(1,t,n,o)}info(t,n,o){this.log(2,t,n,o)}debug(t,n,o){this.log(3,t,n,o)}trace(t,n,o){this.log(4,t,n,o)}log(t,n,o,r){if(t>this.config.level)return;let a={level:t,timestamp:new Date,context:n,message:o,data:r},s=this.formatLogEntry(a);this.config.enableColors?console.log(this.colorize(s,t)):console.log(s),this.config.logToFile&&this.writeToFile(a)}formatLogEntry(t){let n=[];return this.config.enableTimestamp&&n.push(`[${t.timestamp.toISOString()}]`),n.push(`[${me[t.level]}]`),n.push(`[${t.context}]`),n.push(t.message),t.data&&n.push(JSON.stringify(t.data,null,2)),n.join(" ")}colorize(t,n){return`${{0:"\x1B[31m",1:"\x1B[33m",2:"\x1B[36m",3:"\x1B[32m",4:"\x1B[90m"}[n]}${t}\x1B[0m`}initLogFile(){if(!this.logWriter)throw new Error("LogWriter not configured");this.logWriter.init(this.config.logPath)}writeToFile(t){if(!this.logWriter)throw new Error("LogWriter not configured");let n=this.formatLogEntry(t)+`
`;this.logWriter.write(n)}};var dt=()=>{let e=new Map,t=new Map,n=new Set,o=new Map,r=i=>typeof i=="string"?i:typeof i=="symbol"?i.toString():typeof i=="function"?i.name||"anonymous function":"unknown token",a=i=>(typeof i=="string"||typeof i=="symbol")&&o.get(i)||i,s={register:(i,c)=>(t.set(i,c),e.delete(i),s),singleton:(i,c)=>(t.set(i,c),n.add(i),e.delete(i),s),instance:(i,c)=>(e.set(i,c),t.delete(i),n.delete(i),s),alias:(i,c)=>(o.set(i,c),s),resolve:i=>{let c=a(i);if(e.has(c))return e.get(c);let u=t.get(c);if(!u)throw new Error(`No registration found for ${r(c)}`);return n.has(c)?(e.has(c)||e.set(c,u(s)),e.get(c)):u(s)}};return s};var Er=e=>e,mt=e=>{let t={providers:[],booted:new Set,registered:new Set},n=(r,a)=>{t.registered.has(a)||(t.registered.add(a),a.register&&a.register(r))},o=async(r,a)=>{t.booted.has(a)||(t.booted.add(a),a.boot&&await a.boot(r))};return{register:r=>{t.providers.includes(r)||(t.providers.push(r),n(e,r))},bootAll:async()=>{for(let r of t.providers)n(e,r);for(let r of t.providers)await o(e,r)},isBooted:r=>t.booted.has(r),isRegistered:r=>t.registered.has(r)}};import{v7 as gt}from"uuid";var fe=class{queue=[];running=new Set;concurrency;processing=!1;constructor(t=1){this.concurrency=t}setConcurrency(t){this.concurrency=t,this.processQueue()}async processQueue(){if(!this.processing){this.processing=!0;try{for(;this.queue.length>0&&this.running.size<this.concurrency;){this.queue.sort((n,o)=>o.priority-n.priority);let t=this.queue.shift();if(!t)break;this.running.add(t.id),t.execute().then(n=>{t.resolve(n)}).catch(n=>{t.reject(n)}).finally(()=>{this.running.delete(t.id),this.processQueue()})}}finally{this.processing=!1}}}enqueue(t,n=0){return new Promise((o,r)=>{let a={id:gt(),execute:t,priority:n,resolve:o,reject:r};this.queue.push(a),setTimeout(()=>this.processQueue(),0)})}get activeTasksCount(){return this.running.size}get queuedTasksCount(){return this.queue.length}enqueueTask(t,n,o={}){return this.enqueue(()=>t(n,o),o.priority??0)}};function $e(e,t,n){async function o(r,a){let s=a?.callId??gt(),i={...n,...a};delete i.callId;try{return await Promise.resolve(t(r,{callId:s,debug:i?.debug??(()=>{})}))}catch(c){throw c}}return o}import"zod";import In from"zod-to-json-schema";import{z as ft}from"zod";import"@ai-sdk/ui-utils";function D(e,t,n){let o={tag:e};return t&&(o.params=t),n&&(o.children=n),o}function ze(e){let t=e.params?Object.entries(e.params).map(([o,r])=>` ${o}="${r}"`).join(""):"",n=Array.isArray(e.children)?e.children.filter(o=>!!o):e.children;Array.isArray(n)&&n.length===0&&(n=""),n=typeof n=="string"?n:Array.isArray(n)&&n.length>0?`
`+n.map(o=>typeof o=="string"?o:"tag"in o?ze(o):he(o)).join(`
`)+`
`:he(n);try{return n===""?`<${e.tag}${t} />`:`<${e.tag}${t}>${n}</${e.tag}>`}catch(o){throw console.log("failed to format",e),o}}function yt(e){return D("input",{name:e.type,timestamp:e.timestamp,...e.params},e.data)}function ht(e){return D("output",{name:e.type,timestamp:e.timestamp,...e.params},e.data)}function ye(e,t="schema"){return"_type"in e?e.jsonSchema:In("parse"in e?e:ft.object(e),t).definitions[t]}function xt(e){let t={type:e.type};return e.required&&(t.required="true"),D("output",t,[e.description?{tag:"description",children:e.description}:null,e.instructions?{tag:"instructions",children:e.instructions}:null,{tag:"attributes_schema",children:e.attributes?ye(e.attributes,"attributes"):{}},{tag:"content_schema",children:ye(e.schema??ft.string(),"schema")},e.examples?{tag:"examples",children:e.examples}:null])}function bt(e){return D("action",{name:e.name},[e.description?{tag:"description",children:e.description}:null,e.instructions?{tag:"instructions",children:e.instructions}:null,e.schema?{tag:"schema",children:ye(e.schema,"schema")}:null,e.returns?{tag:"returns",children:ye(e.returns,"returns")}:null])}function Ct(e){let{context:t,key:n}=e;return D("context",{type:t.type,key:n},[t.description?{tag:"description",children:typeof t.description=="function"?t.description(e):t.description}:null,t.instructions?{tag:"instructions",children:typeof t.instructions=="function"?t.instructions(e):t.instructions}:null,{tag:"state",children:t.render?t.render(e):e.memory}].flat())}function zr(e){return{tag:"msg",params:e.role==="user"?{role:"user",user:e.user}:{role:"assistant"},children:e.content}}function xe(e){switch(e.ref){case"input":return e.formatted??yt(e);case"output":return e.formatted??ht(e);case"thought":return D("reasoning",{},e.content);case"action_call":return D("action_call",{id:e.id,name:e.name,timestamp:e.timestamp},e.data??e.content);case"action_result":return D("action_result",{callId:e.callId,name:e.name,timestamp:e.timestamp},e.formatted??e.data);case"event":return D("event",{name:e.name,...e.params},e.formatted??e.data);default:throw new Error("invalid context")}}function qr(e){switch(e.ref){case"input":return yt(e);case"output":return ht(e);case"thought":return D("reasoning",{},e.content);case"action_call":return D("action_call",{id:e.id,name:e.name,timestamp:e.timestamp},e.data??e.content);case"action_result":return D("action_result",{callId:e.callId,name:e.name,timestamp:e.timestamp},e.formatted??e.data);case"event":return D("event",{name:e.name,...e.params},e.formatted??e.data);default:throw new Error("invalid context")}}function he(e){return typeof e!="string"?JSON.stringify(e,(t,n)=>typeof n=="bigint"?n.toString():n):e.trim()}function ue(e,t){return e.trim().replace(/\{\{(\w+)\}\}/g,(n,o)=>{let r=t[o]??"";if(typeof r=="object"){if(r&&"tag"in r)return ze(r);r&&he(r)}return Array.isArray(r)?r.map(a=>typeof a=="object"&&a&&"tag"in a?ze(a):he(a)).join(`
`):r??""})}import{z as On}from"zod";import{v7 as U}from"uuid";function Zr(e){return e}function Vr(e){return{...e,schema:e.schema??void 0}}function Hr(e){return e}function Ur(e){return e}function Jr(e,t){let{maxChunkSize:n}=t,o=e.split(`
`),r=[],a="";for(let s of o)a.length+s.length+1>n?(a&&r.push(a.trim()),a=s):a=a?a+`
`+s:s;return a&&r.push(a.trim()),r}function En(e){return e}function Br(e){return{...e,inputs:e.inputs??{}}}function Gr(e,t=process.env){try{return e.parse(t)}catch(n){throw n instanceof On.ZodError&&(console.error("Environment validation failed:"),n.errors.forEach(o=>{console.error(`- ${o.message}`)}),process.exit(1)),n}}var Mn={thoughts:6,inputs:20,outputs:20,actions:20};function Kr(e,t=Mn){e.thoughts=e.thoughts.slice(-t.thoughts),e.inputs=e.inputs.slice(-t.inputs),e.outputs=e.outputs.slice(-t.outputs),e.calls=e.calls.slice(-t.actions),e.results=e.results.slice(-t.actions)}async function oe(e,...t){try{return await e(...t)}catch(n){return Promise.reject(n)}}function qe(e){let t={...e,actions:e.actions??[],inputs:e.inputs??{},outputs:e.outputs??{},events:e.events??{},setActions(n){return qe({...t,actions:n})},setInputs(n){return qe({...t,inputs:n})},setOutputs(n){return qe({...t,outputs:n})}};return t}function jn(e,t=!0){return[...e.inputs??[],...e.outputs??[],...e.calls??[],...(t?e.thoughts:void 0)??[],...e.results??[],...e.events??[]].sort((n,o)=>n.timestamp>o.timestamp?1:-1)}function os(e,t=!0){return[...e.inputs??[],...e.outputs??[],...e.calls??[],...(t?e.thoughts:void 0)??[],...e.results??[],...e.events??[],...e.steps??[],...e.runs??[]].sort((n,o)=>n.timestamp>o.timestamp?1:-1)}function We({memory:e,processed:t,size:n}){let o=jn(e,!1).filter(r=>r.processed===t);return n&&(o=o.slice(-n)),o.map(r=>xe(r)).flat()}function Ln(){return{inputs:[],outputs:[],thoughts:[],calls:[],results:[],runs:[],steps:[],events:[]}}function Tt(e,t){switch(t.ref){case"action_call":e.calls.push(t);break;case"action_result":e.results.push(t);break;case"input":e.inputs.push(t);break;case"output":e.outputs.push(t);break;case"thought":e.thoughts.push(t);break;case"event":e.events.push(t);break;default:throw new Error("invalid ref")}}var Dn={key:"working-memory",create:Ln};function be(e,t){let n=e.key?e.key(t):e.type;return e.key?[e.type,n].join(":"):e.type}async function le({agent:e,context:t,args:n,contexts:o=[],settings:r={}}){let a=t.key?t.key(n):t.type,s=t.key?[t.type,a].join(":"):t.type,i={model:t.model,maxSteps:t.maxSteps,maxWorkingMemorySize:t.maxWorkingMemorySize,...r},c=t.setup?await t.setup(n,i,e):{},u=await e.memory.store.get(`memory:${s}`)??(t.create?await Promise.resolve(t.create({key:a,args:n,id:s,options:c,settings:i},e)):{});return{id:s,key:a,args:n,options:c,context:t,memory:u,settings:i,contexts:o}}async function vt(e,t){let n=await e.memory.store.get(["working-memory",t].join(":"));return n||(n=await Dn.create(),await e.memory.store.set(["working-memory",t].join(":"),n)),n}async function re(e,t,n){return await e.memory.store.set(["working-memory",t].join(":"),n)}async function At(e,t){let{id:n,context:o,key:r,args:a,settings:s,contexts:i}=t;await e.memory.store.set(`context:${n}`,{id:n,type:o.type,key:r,args:a,settings:{...s,model:s.model?.modelId},contexts:i}),t.context.save?await t.context.save(t):await e.memory.store.set(`memory:${n}`,t.memory)}async function Ce(e,t,n){let o=await e.memory.store.get(`context:${n}`);return o?{...o,context:t,settings:{...o?.settings,model:void 0}}:null}async function Fe(e,t){await e.memory.store.set("contexts",Array.from(t.values()))}function Nn(e,t){if(e.has(t)){let r=e.get(t);return{id:t,type:r.context.type,key:r.key,args:r.args,settings:r.settings}}let[n,o]=t.split(":");return{id:t,type:n,key:o}}function wt(e,t){return Array.from(e.values()).map(n=>Nn(t,n))}async function St(e,t){await e.memory.store.delete(`context:${t}`),await e.memory.store.delete(`memory:${t}`),await e.memory.store.delete(`working-memory:${t}`)}function Rt(e,t,n){return{store:e,vector:t,vectorModel:n}}function kt(){let e=new Map;return{async get(t){return e.get(t)??null},async clear(){e.clear()},async delete(t){e.delete(t)},async set(t,n){e.set(t,n)}}}function _t(){return{upsert(e,t){return Promise.resolve()},query(e,t){return Promise.resolve([])},createIndex(e){return Promise.resolve()},deleteIndex(e){return Promise.resolve()}}}import{streamText as cr}from"ai";import{z as sr}from"zod";import{z as Ze}from"zod";var Y=class extends Error{constructor(n){super();this.ref=n}},ee=class extends Error{constructor(n,o){super();this.ref=n;this.parsingError=o}};function $n(e){return e.startsWith("```json")&&(e=e.slice(7,-3)),JSON.parse(e)}function zn(e){let t=[],n=/^\{\{(.*)\}\}$/,o=/^([a-zA-Z_][a-zA-Z0-9_]*)/;function r(a,s){if(typeof a=="object"&&a!==null)if(Array.isArray(a))a.forEach((i,c)=>{r(i,[...s,c])});else for(let i in a)Object.prototype.hasOwnProperty.call(a,i)&&r(a[i],[...s,i]);else if(typeof a=="string"){let i=a.match(n);if(i){let c=i[1].trim(),u=c.match(o),p=u?u[1]:null;t.push({path:s,template_string:a,expression:c,primary_key:p})}}}return r(e,[]),t}function Ve(e){return e.split(/[.\[\]]+/).filter(Boolean)}function Te(e,t){let n=e;for(let o of t){if(n==null)return;let r=parseInt(o,10);if(!isNaN(r)&&Array.isArray(n))n=n[r];else if(typeof n=="object")n=n[o];else return}return n}function It(e,t){if(!t)return e;let n=Ve(t);return Te(e,n)}function qn(e,t,n){let o=e,r=t.length-1;for(let s=0;s<r;s++){let i=t[s],c=t[s+1];if((o[i]===null||o[i]===void 0)&&(o[i]=typeof c=="number"?[]:{}),o=o[i],typeof o!="object"||o===null){console.error(`Cannot set path beyond non-object at segment ${s} ('${i}') for path ${t.join(".")}`);return}}let a=t[r];typeof o=="object"&&o!==null?o[a]=n:console.error(`Cannot set final value, parent at path ${t.slice(0,-1).join(".")} is not an object.`)}async function Ot(e,t,n){for(let o of t){let r;if(!o.primary_key){console.warn(`Template at path ${o.path.join(".")} has no primary key: ${o.template_string}`);continue}let a=o.expression.substring(o.primary_key.length).replace(/^\./,"");try{r=await n(o.primary_key,a)}catch(s){console.error(`Error resolving template at path ${o.path.join(".")}: ${s}`)}if(r===void 0)throw console.warn(`Could not resolve template "${o.template_string}" at path ${o.path.join(".")}. Path or source might be invalid.`),new Error(`Could not resolve template "${o.template_string}" at path ${o.path.join(".")}. Path or source might be invalid.`);qn(e,o.path,r)}}async function Et({call:e,actions:t,logger:n}){let o=t.find(r=>r.name===e.name);if(!o)throw n.error("agent:action","ACTION_MISMATCH",{name:e.name,data:e.content}),new Y(e);try{let r=e.content.trim(),a=r.length>0?$n(r):{},s=zn(a);return{action:o,json:a,templates:s}}catch(r){throw new ee(e,r)}}async function Mt({state:e,workingMemory:t,action:n,logger:o,call:r,taskRunner:a,agent:s,agentState:i,abortSignal:c,pushLog:u}){let p;n.memory&&(p=await s.memory.store.get(n.memory.key)??n.memory.create());let h={...e,workingMemory:t,actionMemory:p,agentMemory:i?.memory,abortSignal:c,call:r,push(b){u?u(b):Tt(t,b)},emit(b,y,d){console.log("emitting",{event:b,args:y});let T={ref:"event",id:U(),name:b,data:y,processed:d?.processed??!0,timestamp:Date.now()};u?u(T):t.events.push(T)}};r.processed=!0;let C={ref:"action_result",id:U(),callId:r.id,data:void 0,name:r.name,timestamp:Date.now(),processed:!1};return C.data=await a.enqueueTask($t,{action:n,agent:s,logger:o,ctx:h},{debug:s.debugger,retry:n.retry,abortSignal:c}),n.format&&(C.formatted=n.format(C)),n.memory&&await s.memory.store.set(n.memory.key,p),n.onSuccess&&await Promise.try(n.onSuccess,C,h,s),C}async function jt({outputRef:e,outputs:t,logger:n,state:o,workingMemory:r,agent:a}){let s=t.find(i=>i.type===e.type);if(!s)throw new Y(e);if(n.debug("agent:output",e.type,e.data),s.schema){let i="parse"in s.schema?s.schema:Ze.object(s.schema),c=e.content;try{typeof c=="string"&&i._def.typeName!=="ZodString"&&(c=JSON.parse(c.trim())),e.data=i.parse(c)}catch(u){throw new ee(e,u)}}if(s.handler){let i=await Promise.try(s.handler,e.data,{...o,workingMemory:r,outputRef:e},a);if(Array.isArray(i)){let c=[];for(let u of i){let p={...e,id:U(),processed:u.processed??!0,...u};p.formatted=s.format?s.format(i):void 0,c.push(p)}return c}else if(i){let c={...e,...i,processed:i.processed??!0};return c.formatted=s.format?s.format(i):void 0,c}}return{...e,formatted:s.format?s.format(e.data):void 0,processed:!0}}async function Pt(e){let{context:t,state:n}=e,o=typeof t.actions=="function"?await Promise.try(t.actions,n):t.actions;return Promise.all(o.map(r=>Lt({action:r,...e}))).then(r=>r.filter(a=>!!a))}async function Lt({action:e,context:t,state:n,workingMemory:o,agent:r,agentCtxState:a}){if(e.context&&e.context.type!==t.type)return;let s;e.memory&&(s=await r.memory.store.get(e.memory.key)??e.memory.create());let i=e.enabled?e.enabled({...n,context:t,workingMemory:o,actionMemory:s,agentMemory:a?.memory}):!0;return e.enabled&&s&&await r.memory.store.set(s.key,s),i?{...e,ctxId:n.id}:void 0}async function Dt({agent:e,ctxState:t,agentCtxState:n,workingMemory:o,params:r}){await n?.context.loader?.(n,e),await t?.context.loader?.(t,e);let a=Object.entries({...e.inputs,...t.context.inputs,...r?.inputs??{}}).map(([y,d])=>({type:y,...d})),s=Object.entries({...e.outputs,...t.context.outputs,...r?.outputs??{}}).filter(([y,d])=>d.enabled?d.enabled({...t,workingMemory:o}):!0).map(([y,d])=>({type:y,...d})),i=await Promise.all([e.actions,r?.actions].filter(y=>!!y).flat().map(y=>Lt({action:y,agent:e,agentCtxState:n,context:t.context,state:t,workingMemory:o}))).then(y=>y.filter(d=>!!d)),c=await Pt({agent:e,agentCtxState:n,context:t.context,state:t,workingMemory:o});i.push(...c);let u=await Promise.all([...(t?.contexts??[]).map(y=>e.getContextById(y)),...(r?.contexts??[]).map(y=>e.getContext(y))]).then(y=>y.filter(d=>!!d));await Promise.all(u.map(y=>y.context.loader?.(y,e)));let p=u.map(y=>Object.entries(y.context.inputs)).flat().map(([y,d])=>({type:y,...d}));a.push(...p);let h=u.map(y=>Object.entries(y.context.outputs)).flat().map(([y,d])=>({type:y,...d}));s.push(...h);let C=await Promise.all(u.map(y=>Pt({agent:e,agentCtxState:n,context:y.context,state:y,workingMemory:o})));return i.push(...C.flat()),{contexts:[n,t,...u].filter(y=>!!y),outputs:s,actions:i,inputs:a}}async function Nt({inputs:e,inputRef:t,logger:n,ctxState:o,workingMemory:r,agent:a}){let s=e[t.type];if(!s)throw new Y(t);try{if(s.schema){let c="parse"in s.schema?s.schema:Ze.object(s.schema);t.data=c.parse(t.content)}else t.data=Ze.string().parse(t.content)}catch(c){throw new ee(t,c)}n.debug("agent:send","Querying episodic memory");let i=await a.memory.vector.query(`${o.id}`,JSON.stringify(t.data));if(n.trace("agent:send","Episodic memory retrieved",{episodesCount:i.length}),r.episodicMemory={episodes:i},s.handler){n.debug("agent:send","Using custom input handler",{type:t.type});let{data:c,params:u}=await Promise.try(s.handler,t.data,{...o,workingMemory:r},a);t.data=c,u&&(t.params={...t.params,...u})}t.formatted=s.format?s.format(t):void 0}import{generateObject as Qo}from"ai";import{InvalidArgumentError as Hn}from"@ai-sdk/provider";var zt=(e,t=21)=>(n=t)=>{let o="",r=n|0;for(;r--;)o+=e[Math.random()*e.length|0];return o};var Re=Pn(Vt(),1);import{APICallError as bs}from"@ai-sdk/provider";import{LoadAPIKeyError as ve}from"@ai-sdk/provider";import{LoadSettingError as vs}from"@ai-sdk/provider";import{JSONParseError as we,TypeValidationError as Bn}from"@ai-sdk/provider";import{TypeValidationError as Je}from"@ai-sdk/provider";import{InvalidArgumentError as to}from"@ai-sdk/provider";import{APICallError as pe}from"@ai-sdk/provider";import{APICallError as Ae,EmptyResponseBodyError as ro}from"@ai-sdk/provider";function Z(...e){return e.reduce((t,n)=>({...t,...n??{}}),{})}function Zn(){let e="",t,n=[],o,r;function a(c,u){if(c===""){s(u);return}if(c.startsWith(":"))return;let p=c.indexOf(":");if(p===-1){i(c,"");return}let h=c.slice(0,p),C=p+1,b=C<c.length&&c[C]===" "?c.slice(C+1):c.slice(C);i(h,b)}function s(c){n.length>0&&(c.enqueue({event:t,data:n.join(`
`),id:o,retry:r}),n=[],t=void 0,r=void 0)}function i(c,u){switch(c){case"event":t=u;break;case"data":n.push(u);break;case"id":o=u;break;case"retry":let p=parseInt(u,10);isNaN(p)||(r=p);break}}return new TransformStream({transform(c,u){let{lines:p,incompleteLine:h}=Vn(e,c);e=h;for(let C=0;C<p.length;C++)a(p[C],u)},flush(c){a(e,c),s(c)}})}function Vn(e,t){let n=[],o=e;for(let r=0;r<t.length;){let a=t[r++];a===`
`?(n.push(o),o=""):a==="\r"?(n.push(o),o="",t[r+1]===`
`&&r++):o+=a}return{lines:n,incompleteLine:o}}function Se(e){let t={};return e.headers.forEach((n,o)=>{t[o]=n}),t}var Un=({prefix:e,size:t=16,alphabet:n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:o="-"}={})=>{let r=zt(n,t);if(e==null)return r;if(n.includes(o))throw new Hn({argument:"separator",message:`The separator "${o}" must not be part of the alphabet "${n}".`});return a=>`${e}${o}${r(a)}`},B=Un();function Jn(e){return Object.fromEntries(Object.entries(e).filter(([t,n])=>n!=null))}function Ue(e){return e instanceof Error&&(e.name==="AbortError"||e.name==="TimeoutError")}function Ht({apiKey:e,environmentVariableName:t,apiKeyParameterName:n="apiKey",description:o}){if(typeof e=="string")return e;if(e!=null)throw new ve({message:`${o} API key must be a string.`});if(typeof process>"u")throw new ve({message:`${o} API key is missing. Pass it using the '${n}' parameter. Environment variables is not supported in this environment.`});if(e=process.env[t],e==null)throw new ve({message:`${o} API key is missing. Pass it using the '${n}' parameter or the ${t} environment variable.`});if(typeof e!="string")throw new ve({message:`${o} API key must be a string. The value of the ${t} environment variable is not a string.`});return e}var Be=Symbol.for("vercel.ai.validator");function Gn(e){return{[Be]:!0,validate:e}}function Kn(e){return typeof e=="object"&&e!==null&&Be in e&&e[Be]===!0&&"validate"in e}function Xn(e){return Kn(e)?e:Qn(e)}function Qn(e){return Gn(t=>{let n=e.safeParse(t);return n.success?{success:!0,value:n.data}:{success:!1,error:n.error}})}function Yn({value:e,schema:t}){let n=Ge({value:e,schema:t});if(!n.success)throw Je.wrap({value:e,cause:n.error});return n.value}function Ge({value:e,schema:t}){let n=Xn(t);try{if(n.validate==null)return{success:!0,value:e};let o=n.validate(e);return o.success?o:{success:!1,error:Je.wrap({value:e,cause:o.error})}}catch(o){return{success:!1,error:Je.wrap({value:e,cause:o})}}}function eo({text:e,schema:t}){try{let n=Re.default.parse(e);return t==null?n:Yn({value:n,schema:t})}catch(n){throw we.isInstance(n)||Bn.isInstance(n)?n:new we({text:e,cause:n})}}function Ut({text:e,schema:t}){try{let n=Re.default.parse(e);if(t==null)return{success:!0,value:n,rawValue:n};let o=Ge({value:n,schema:t});return o.success?{...o,rawValue:n}:o}catch(n){return{success:!1,error:we.isInstance(n)?n:new we({text:e,cause:n})}}}function Ke(e){try{return Re.default.parse(e),!0}catch{return!1}}function Jt({provider:e,providerOptions:t,schema:n}){if(t?.[e]==null)return;let o=Ge({value:t[e],schema:n});if(!o.success)throw new to({argument:"providerOptions",message:`invalid ${e} provider options`,cause:o.error});return o.value}var no=()=>globalThis.fetch,V=async({url:e,headers:t,body:n,failedResponseHandler:o,successfulResponseHandler:r,abortSignal:a,fetch:s})=>oo({url:e,headers:{"Content-Type":"application/json",...t},body:{content:JSON.stringify(n),values:n},failedResponseHandler:o,successfulResponseHandler:r,abortSignal:a,fetch:s}),oo=async({url:e,headers:t={},body:n,successfulResponseHandler:o,failedResponseHandler:r,abortSignal:a,fetch:s=no()})=>{try{let i=await s(e,{method:"POST",headers:Jn(t),body:n.content,signal:a}),c=Se(i);if(!i.ok){let u;try{u=await r({response:i,url:e,requestBodyValues:n.values})}catch(p){throw Ue(p)||pe.isInstance(p)?p:new pe({message:"Failed to process error response",cause:p,statusCode:i.status,url:e,responseHeaders:c,requestBodyValues:n.values})}throw u.value}try{return await o({response:i,url:e,requestBodyValues:n.values})}catch(u){throw u instanceof Error&&(Ue(u)||pe.isInstance(u))?u:new pe({message:"Failed to process successful response",cause:u,statusCode:i.status,url:e,responseHeaders:c,requestBodyValues:n.values})}}catch(i){if(Ue(i))throw i;if(i instanceof TypeError&&i.message==="fetch failed"){let c=i.cause;if(c!=null)throw new pe({message:`Cannot connect to API: ${c.message}`,cause:c,url:e,requestBodyValues:n.values,isRetryable:!0})}throw i}};var Bt=({errorSchema:e,errorToMessage:t,isRetryable:n})=>async({response:o,url:r,requestBodyValues:a})=>{let s=await o.text(),i=Se(o);if(s.trim()==="")return{responseHeaders:i,value:new Ae({message:o.statusText,url:r,requestBodyValues:a,statusCode:o.status,responseHeaders:i,responseBody:s,isRetryable:n?.(o)})};try{let c=eo({text:s,schema:e});return{responseHeaders:i,value:new Ae({message:t(c),url:r,requestBodyValues:a,statusCode:o.status,responseHeaders:i,responseBody:s,data:c,isRetryable:n?.(o,c)})}}catch{return{responseHeaders:i,value:new Ae({message:o.statusText,url:r,requestBodyValues:a,statusCode:o.status,responseHeaders:i,responseBody:s,isRetryable:n?.(o)})}}},ae=e=>async({response:t})=>{let n=Se(t);if(t.body==null)throw new ro({});return{responseHeaders:n,value:t.body.pipeThrough(new TextDecoderStream).pipeThrough(Zn()).pipeThrough(new TransformStream({transform({data:o},r){o!=="[DONE]"&&r.enqueue(Ut({text:o,schema:e}))}}))}};var J=e=>async({response:t,url:n,requestBodyValues:o})=>{let r=await t.text(),a=Ut({text:r,schema:e}),s=Se(t);if(!a.success)throw new Ae({message:"Invalid JSON response",cause:a.error,statusCode:t.status,responseHeaders:s,responseBody:r,url:n,requestBodyValues:o});return{responseHeaders:s,value:a.value,rawValue:a.rawValue}};var{btoa:so,atob:_s}=globalThis;function ke(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCodePoint(e[n]);return so(t)}function Gt(e){return e?.replace(/\/$/,"")}import{InvalidResponseDataError as Xe,UnsupportedFunctionalityError as Kt}from"@ai-sdk/provider";import{z as v}from"zod";import{UnsupportedFunctionalityError as Qe}from"@ai-sdk/provider";import{z as K}from"zod";import{UnsupportedFunctionalityError as Qt}from"@ai-sdk/provider";import{UnsupportedFunctionalityError as _e}from"@ai-sdk/provider";import{z as P}from"zod";import{InvalidPromptError as fo,UnsupportedFunctionalityError as Ye}from"@ai-sdk/provider";import{TooManyEmbeddingValuesForCallError as Co}from"@ai-sdk/provider";import{z as te}from"zod";import{z as Pe}from"zod";import{z as g}from"zod";import{UnsupportedFunctionalityError as en}from"@ai-sdk/provider";import{UnsupportedFunctionalityError as ko}from"@ai-sdk/provider";import{z as Jo}from"zod";function ao({prompt:e,useLegacyFunctionCalling:t=!1,systemMessageMode:n="system"}){let o=[],r=[];for(let{role:a,content:s}of e)switch(a){case"system":{switch(n){case"system":{o.push({role:"system",content:s});break}case"developer":{o.push({role:"developer",content:s});break}case"remove":{r.push({type:"other",message:"system messages are removed for this model"});break}default:{let i=n;throw new Error(`Unsupported system message mode: ${i}`)}}break}case"user":{if(s.length===1&&s[0].type==="text"){o.push({role:"user",content:s[0].text});break}o.push({role:"user",content:s.map((i,c)=>{var u,p,h,C;switch(i.type){case"text":return{type:"text",text:i.text};case"image":return{type:"image_url",image_url:{url:i.image instanceof URL?i.image.toString():`data:${(u=i.mimeType)!=null?u:"image/jpeg"};base64,${ke(i.image)}`,detail:(h=(p=i.providerMetadata)==null?void 0:p.openai)==null?void 0:h.imageDetail}};case"file":{if(i.data instanceof URL)throw new Qe({functionality:"'File content parts with URL data' functionality not supported."});switch(i.mimeType){case"audio/wav":return{type:"input_audio",input_audio:{data:i.data,format:"wav"}};case"audio/mp3":case"audio/mpeg":return{type:"input_audio",input_audio:{data:i.data,format:"mp3"}};case"application/pdf":return{type:"file",file:{filename:(C=i.filename)!=null?C:`part-${c}.pdf`,file_data:`data:application/pdf;base64,${i.data}`}};default:throw new Qe({functionality:`File content part type ${i.mimeType} in user messages`})}}}})});break}case"assistant":{let i="",c=[];for(let u of s)switch(u.type){case"text":{i+=u.text;break}case"tool-call":{c.push({id:u.toolCallId,type:"function",function:{name:u.toolName,arguments:JSON.stringify(u.args)}});break}}if(t){if(c.length>1)throw new Qe({functionality:"useLegacyFunctionCalling with multiple tool calls in one message"});o.push({role:"assistant",content:i,function_call:c.length>0?c[0].function:void 0})}else o.push({role:"assistant",content:i,tool_calls:c.length>0?c:void 0});break}case"tool":{for(let i of s)t?o.push({role:"function",name:i.toolName,content:JSON.stringify(i.result)}):o.push({role:"tool",tool_call_id:i.toolCallId,content:JSON.stringify(i.result)});break}default:{let i=a;throw new Error(`Unsupported role: ${i}`)}}return{messages:o,warnings:r}}function Xt(e){var t,n;return(n=(t=e?.content)==null?void 0:t.map(({token:o,logprob:r,top_logprobs:a})=>({token:o,logprob:r,topLogprobs:a?a.map(({token:s,logprob:i})=>({token:s,logprob:i})):[]})))!=null?n:void 0}function Ie(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var tt=K.object({error:K.object({message:K.string(),type:K.string().nullish(),param:K.any().nullish(),code:K.union([K.string(),K.number()]).nullish()})}),X=Bt({errorSchema:tt,errorToMessage:e=>e.error.message});function Oe({id:e,model:t,created:n}){return{id:e??void 0,modelId:t??void 0,timestamp:n!=null?new Date(n*1e3):void 0}}function io({mode:e,useLegacyFunctionCalling:t=!1,structuredOutputs:n}){var o;let r=(o=e.tools)!=null&&o.length?e.tools:void 0,a=[];if(r==null)return{tools:void 0,tool_choice:void 0,toolWarnings:a};let s=e.toolChoice;if(t){let u=[];for(let h of r)h.type==="provider-defined"?a.push({type:"unsupported-tool",tool:h}):u.push({name:h.name,description:h.description,parameters:h.parameters});if(s==null)return{functions:u,function_call:void 0,toolWarnings:a};switch(s.type){case"auto":case"none":case void 0:return{functions:u,function_call:void 0,toolWarnings:a};case"required":throw new Qt({functionality:"useLegacyFunctionCalling and toolChoice: required"});default:return{functions:u,function_call:{name:s.toolName},toolWarnings:a}}}let i=[];for(let u of r)u.type==="provider-defined"?a.push({type:"unsupported-tool",tool:u}):i.push({type:"function",function:{name:u.name,description:u.description,parameters:u.parameters,strict:n?!0:void 0}});if(s==null)return{tools:i,tool_choice:void 0,toolWarnings:a};let c=s.type;switch(c){case"auto":case"none":case"required":return{tools:i,tool_choice:c,toolWarnings:a};case"tool":return{tools:i,tool_choice:{type:"function",function:{name:s.toolName}},toolWarnings:a};default:{let u=c;throw new Qt({functionality:`Unsupported tool choice type: ${u}`})}}}var co=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get supportsStructuredOutputs(){var e;return(e=this.settings.structuredOutputs)!=null?e:et(this.modelId)}get defaultObjectGenerationMode(){return po(this.modelId)?"tool":this.supportsStructuredOutputs?"json":"tool"}get provider(){return this.config.provider}get supportsImageUrls(){return!this.settings.downloadImages}getArgs({mode:e,prompt:t,maxTokens:n,temperature:o,topP:r,topK:a,frequencyPenalty:s,presencePenalty:i,stopSequences:c,responseFormat:u,seed:p,providerMetadata:h}){var C,b,y,d,T,R,L,j;let O=e.type,f=[];a!=null&&f.push({type:"unsupported-setting",setting:"topK"}),u?.type==="json"&&u.schema!=null&&!this.supportsStructuredOutputs&&f.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});let x=this.settings.useLegacyFunctionCalling;if(x&&this.settings.parallelToolCalls===!0)throw new Kt({functionality:"useLegacyFunctionCalling with parallelToolCalls"});if(x&&this.supportsStructuredOutputs)throw new Kt({functionality:"structuredOutputs with useLegacyFunctionCalling"});let{messages:A,warnings:w}=ao({prompt:t,useLegacyFunctionCalling:x,systemMessageMode:mo(this.modelId)});f.push(...w);let m={model:this.modelId,logit_bias:this.settings.logitBias,logprobs:this.settings.logprobs===!0||typeof this.settings.logprobs=="number"?!0:void 0,top_logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:n,temperature:o,top_p:r,frequency_penalty:s,presence_penalty:i,response_format:u?.type==="json"?this.supportsStructuredOutputs&&u.schema!=null?{type:"json_schema",json_schema:{schema:u.schema,strict:!0,name:(C=u.name)!=null?C:"response",description:u.description}}:{type:"json_object"}:void 0,stop:c,seed:p,max_completion_tokens:(b=h?.openai)==null?void 0:b.maxCompletionTokens,store:(y=h?.openai)==null?void 0:y.store,metadata:(d=h?.openai)==null?void 0:d.metadata,prediction:(T=h?.openai)==null?void 0:T.prediction,reasoning_effort:(L=(R=h?.openai)==null?void 0:R.reasoningEffort)!=null?L:this.settings.reasoningEffort,messages:A};switch(et(this.modelId)&&(m.temperature!=null&&(m.temperature=void 0,f.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),m.top_p!=null&&(m.top_p=void 0,f.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"})),m.frequency_penalty!=null&&(m.frequency_penalty=void 0,f.push({type:"unsupported-setting",setting:"frequencyPenalty",details:"frequencyPenalty is not supported for reasoning models"})),m.presence_penalty!=null&&(m.presence_penalty=void 0,f.push({type:"unsupported-setting",setting:"presencePenalty",details:"presencePenalty is not supported for reasoning models"})),m.logit_bias!=null&&(m.logit_bias=void 0,f.push({type:"other",message:"logitBias is not supported for reasoning models"})),m.logprobs!=null&&(m.logprobs=void 0,f.push({type:"other",message:"logprobs is not supported for reasoning models"})),m.top_logprobs!=null&&(m.top_logprobs=void 0,f.push({type:"other",message:"topLogprobs is not supported for reasoning models"})),m.max_tokens!=null&&(m.max_completion_tokens==null&&(m.max_completion_tokens=m.max_tokens),m.max_tokens=void 0)),O){case"regular":{let{tools:l,tool_choice:_,functions:E,function_call:k,toolWarnings:I}=io({mode:e,useLegacyFunctionCalling:x,structuredOutputs:this.supportsStructuredOutputs});return{args:{...m,tools:l,tool_choice:_,functions:E,function_call:k},warnings:[...f,...I]}}case"object-json":return{args:{...m,response_format:this.supportsStructuredOutputs&&e.schema!=null?{type:"json_schema",json_schema:{schema:e.schema,strict:!0,name:(j=e.name)!=null?j:"response",description:e.description}}:{type:"json_object"}},warnings:f};case"object-tool":return{args:x?{...m,function_call:{name:e.tool.name},functions:[{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}]}:{...m,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:this.supportsStructuredOutputs?!0:void 0}}]},warnings:f};default:{let l=O;throw new Error(`Unsupported type: ${l}`)}}}async doGenerate(e){var t,n,o,r,a,s,i,c;let{args:u,warnings:p}=this.getArgs(e),{responseHeaders:h,value:C,rawValue:b}=await V({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Z(this.config.headers(),e.headers),body:u,failedResponseHandler:X,successfulResponseHandler:J(uo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:y,...d}=u,T=C.choices[0],R=(t=C.usage)==null?void 0:t.completion_tokens_details,L=(n=C.usage)==null?void 0:n.prompt_tokens_details,j={openai:{}};return R?.reasoning_tokens!=null&&(j.openai.reasoningTokens=R?.reasoning_tokens),R?.accepted_prediction_tokens!=null&&(j.openai.acceptedPredictionTokens=R?.accepted_prediction_tokens),R?.rejected_prediction_tokens!=null&&(j.openai.rejectedPredictionTokens=R?.rejected_prediction_tokens),L?.cached_tokens!=null&&(j.openai.cachedPromptTokens=L?.cached_tokens),{text:(o=T.message.content)!=null?o:void 0,toolCalls:this.settings.useLegacyFunctionCalling&&T.message.function_call?[{toolCallType:"function",toolCallId:B(),toolName:T.message.function_call.name,args:T.message.function_call.arguments}]:(r=T.message.tool_calls)==null?void 0:r.map(O=>{var f;return{toolCallType:"function",toolCallId:(f=O.id)!=null?f:B(),toolName:O.function.name,args:O.function.arguments}}),finishReason:Ie(T.finish_reason),usage:{promptTokens:(s=(a=C.usage)==null?void 0:a.prompt_tokens)!=null?s:NaN,completionTokens:(c=(i=C.usage)==null?void 0:i.completion_tokens)!=null?c:NaN},rawCall:{rawPrompt:y,rawSettings:d},rawResponse:{headers:h,body:b},request:{body:JSON.stringify(u)},response:Oe(C),warnings:p,logprobs:Xt(T.logprobs),providerMetadata:j}}async doStream(e){if(this.settings.simulateStreaming){let d=await this.doGenerate(e);return{stream:new ReadableStream({start(R){if(R.enqueue({type:"response-metadata",...d.response}),d.text&&R.enqueue({type:"text-delta",textDelta:d.text}),d.toolCalls)for(let L of d.toolCalls)R.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:L.toolCallId,toolName:L.toolName,argsTextDelta:L.args}),R.enqueue({type:"tool-call",...L});R.enqueue({type:"finish",finishReason:d.finishReason,usage:d.usage,logprobs:d.logprobs,providerMetadata:d.providerMetadata}),R.close()}}),rawCall:d.rawCall,rawResponse:d.rawResponse,warnings:d.warnings}}let{args:t,warnings:n}=this.getArgs(e),o={...t,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},{responseHeaders:r,value:a}=await V({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Z(this.config.headers(),e.headers),body:o,failedResponseHandler:X,successfulResponseHandler:ae(lo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:s,...i}=t,c=[],u="unknown",p={promptTokens:void 0,completionTokens:void 0},h,C=!0,{useLegacyFunctionCalling:b}=this.settings,y={openai:{}};return{stream:a.pipeThrough(new TransformStream({transform(d,T){var R,L,j,O,f,x,A,w,m,l,_,E;if(!d.success){u="error",T.enqueue({type:"error",error:d.error});return}let k=d.value;if("error"in k){u="error",T.enqueue({type:"error",error:k.error});return}if(C&&(C=!1,T.enqueue({type:"response-metadata",...Oe(k)})),k.usage!=null){let{prompt_tokens:M,completion_tokens:H,prompt_tokens_details:$,completion_tokens_details:S}=k.usage;p={promptTokens:M??void 0,completionTokens:H??void 0},S?.reasoning_tokens!=null&&(y.openai.reasoningTokens=S?.reasoning_tokens),S?.accepted_prediction_tokens!=null&&(y.openai.acceptedPredictionTokens=S?.accepted_prediction_tokens),S?.rejected_prediction_tokens!=null&&(y.openai.rejectedPredictionTokens=S?.rejected_prediction_tokens),$?.cached_tokens!=null&&(y.openai.cachedPromptTokens=$?.cached_tokens)}let I=k.choices[0];if(I?.finish_reason!=null&&(u=Ie(I.finish_reason)),I?.delta==null)return;let W=I.delta;W.content!=null&&T.enqueue({type:"text-delta",textDelta:W.content});let N=Xt(I?.logprobs);N?.length&&(h===void 0&&(h=[]),h.push(...N));let z=b&&W.function_call!=null?[{type:"function",id:B(),function:W.function_call,index:0}]:W.tool_calls;if(z!=null)for(let M of z){let H=M.index;if(c[H]==null){if(M.type!=="function")throw new Xe({data:M,message:"Expected 'function' type."});if(M.id==null)throw new Xe({data:M,message:"Expected 'id' to be a string."});if(((R=M.function)==null?void 0:R.name)==null)throw new Xe({data:M,message:"Expected 'function.name' to be a string."});c[H]={id:M.id,type:"function",function:{name:M.function.name,arguments:(L=M.function.arguments)!=null?L:""},hasFinished:!1};let S=c[H];((j=S.function)==null?void 0:j.name)!=null&&((O=S.function)==null?void 0:O.arguments)!=null&&(S.function.arguments.length>0&&T.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:S.id,toolName:S.function.name,argsTextDelta:S.function.arguments}),Ke(S.function.arguments)&&(T.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(f=S.id)!=null?f:B(),toolName:S.function.name,args:S.function.arguments}),S.hasFinished=!0));continue}let $=c[H];$.hasFinished||(((x=M.function)==null?void 0:x.arguments)!=null&&($.function.arguments+=(w=(A=M.function)==null?void 0:A.arguments)!=null?w:""),T.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:$.id,toolName:$.function.name,argsTextDelta:(m=M.function.arguments)!=null?m:""}),((l=$.function)==null?void 0:l.name)!=null&&((_=$.function)==null?void 0:_.arguments)!=null&&Ke($.function.arguments)&&(T.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(E=$.id)!=null?E:B(),toolName:$.function.name,args:$.function.arguments}),$.hasFinished=!0))}},flush(d){var T,R;d.enqueue({type:"finish",finishReason:u,logprobs:h,usage:{promptTokens:(T=p.promptTokens)!=null?T:NaN,completionTokens:(R=p.completionTokens)!=null?R:NaN},...y!=null?{providerMetadata:y}:{}})}})),rawCall:{rawPrompt:s,rawSettings:i},rawResponse:{headers:r},request:{body:JSON.stringify(o)},warnings:n}}},nn=v.object({prompt_tokens:v.number().nullish(),completion_tokens:v.number().nullish(),prompt_tokens_details:v.object({cached_tokens:v.number().nullish()}).nullish(),completion_tokens_details:v.object({reasoning_tokens:v.number().nullish(),accepted_prediction_tokens:v.number().nullish(),rejected_prediction_tokens:v.number().nullish()}).nullish()}).nullish(),uo=v.object({id:v.string().nullish(),created:v.number().nullish(),model:v.string().nullish(),choices:v.array(v.object({message:v.object({role:v.literal("assistant").nullish(),content:v.string().nullish(),function_call:v.object({arguments:v.string(),name:v.string()}).nullish(),tool_calls:v.array(v.object({id:v.string().nullish(),type:v.literal("function"),function:v.object({name:v.string(),arguments:v.string()})})).nullish()}),index:v.number(),logprobs:v.object({content:v.array(v.object({token:v.string(),logprob:v.number(),top_logprobs:v.array(v.object({token:v.string(),logprob:v.number()}))})).nullable()}).nullish(),finish_reason:v.string().nullish()})),usage:nn}),lo=v.union([v.object({id:v.string().nullish(),created:v.number().nullish(),model:v.string().nullish(),choices:v.array(v.object({delta:v.object({role:v.enum(["assistant"]).nullish(),content:v.string().nullish(),function_call:v.object({name:v.string().optional(),arguments:v.string().optional()}).nullish(),tool_calls:v.array(v.object({index:v.number(),id:v.string().nullish(),type:v.literal("function").optional(),function:v.object({name:v.string().nullish(),arguments:v.string().nullish()})})).nullish()}).nullish(),logprobs:v.object({content:v.array(v.object({token:v.string(),logprob:v.number(),top_logprobs:v.array(v.object({token:v.string(),logprob:v.number()}))})).nullable()}).nullish(),finish_reason:v.string().nullable().optional(),index:v.number()})),usage:nn}),tt]);function et(e){return e==="o1"||e.startsWith("o1-")||e==="o3"||e.startsWith("o3-")}function po(e){return e.startsWith("gpt-4o-audio-preview")}function mo(e){var t,n;return et(e)?(n=(t=go[e])==null?void 0:t.systemMessageMode)!=null?n:"developer":"system"}var go={"o1-mini":{systemMessageMode:"remove"},"o1-mini-2024-09-12":{systemMessageMode:"remove"},"o1-preview":{systemMessageMode:"remove"},"o1-preview-2024-09-12":{systemMessageMode:"remove"},"o3-mini":{systemMessageMode:"developer"},"o3-mini-2025-01-31":{systemMessageMode:"developer"}};function yo({prompt:e,inputFormat:t,user:n="user",assistant:o="assistant"}){if(t==="prompt"&&e.length===1&&e[0].role==="user"&&e[0].content.length===1&&e[0].content[0].type==="text")return{prompt:e[0].content[0].text};let r="";e[0].role==="system"&&(r+=`${e[0].content}

`,e=e.slice(1));for(let{role:a,content:s}of e)switch(a){case"system":throw new fo({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{let i=s.map(c=>{switch(c.type){case"text":return c.text;case"image":throw new Ye({functionality:"images"})}}).join("");r+=`${n}:
${i}

`;break}case"assistant":{let i=s.map(c=>{switch(c.type){case"text":return c.text;case"tool-call":throw new Ye({functionality:"tool-call messages"})}}).join("");r+=`${o}:
${i}

`;break}case"tool":throw new Ye({functionality:"tool messages"});default:{let i=a;throw new Error(`Unsupported role: ${i}`)}}return r+=`${o}:
`,{prompt:r,stopSequences:[`
${n}:`]}}function Yt(e){return e?.tokens.map((t,n)=>({token:t,logprob:e.token_logprobs[n],topLogprobs:e.top_logprobs?Object.entries(e.top_logprobs[n]).map(([o,r])=>({token:o,logprob:r})):[]}))}var ho=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:t,prompt:n,maxTokens:o,temperature:r,topP:a,topK:s,frequencyPenalty:i,presencePenalty:c,stopSequences:u,responseFormat:p,seed:h}){var C;let b=e.type,y=[];s!=null&&y.push({type:"unsupported-setting",setting:"topK"}),p!=null&&p.type!=="text"&&y.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});let{prompt:d,stopSequences:T}=yo({prompt:n,inputFormat:t}),R=[...T??[],...u??[]],L={model:this.modelId,echo:this.settings.echo,logit_bias:this.settings.logitBias,logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:o,temperature:r,top_p:a,frequency_penalty:i,presence_penalty:c,seed:h,prompt:d,stop:R.length>0?R:void 0};switch(b){case"regular":{if((C=e.tools)!=null&&C.length)throw new _e({functionality:"tools"});if(e.toolChoice)throw new _e({functionality:"toolChoice"});return{args:L,warnings:y}}case"object-json":throw new _e({functionality:"object-json mode"});case"object-tool":throw new _e({functionality:"object-tool mode"});default:{let j=b;throw new Error(`Unsupported type: ${j}`)}}}async doGenerate(e){let{args:t,warnings:n}=this.getArgs(e),{responseHeaders:o,value:r,rawValue:a}=await V({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Z(this.config.headers(),e.headers),body:t,failedResponseHandler:X,successfulResponseHandler:J(xo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:s,...i}=t,c=r.choices[0];return{text:c.text,usage:{promptTokens:r.usage.prompt_tokens,completionTokens:r.usage.completion_tokens},finishReason:Ie(c.finish_reason),logprobs:Yt(c.logprobs),rawCall:{rawPrompt:s,rawSettings:i},rawResponse:{headers:o,body:a},response:Oe(r),warnings:n,request:{body:JSON.stringify(t)}}}async doStream(e){let{args:t,warnings:n}=this.getArgs(e),o={...t,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},{responseHeaders:r,value:a}=await V({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Z(this.config.headers(),e.headers),body:o,failedResponseHandler:X,successfulResponseHandler:ae(bo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:s,...i}=t,c="unknown",u={promptTokens:Number.NaN,completionTokens:Number.NaN},p,h=!0;return{stream:a.pipeThrough(new TransformStream({transform(C,b){if(!C.success){c="error",b.enqueue({type:"error",error:C.error});return}let y=C.value;if("error"in y){c="error",b.enqueue({type:"error",error:y.error});return}h&&(h=!1,b.enqueue({type:"response-metadata",...Oe(y)})),y.usage!=null&&(u={promptTokens:y.usage.prompt_tokens,completionTokens:y.usage.completion_tokens});let d=y.choices[0];d?.finish_reason!=null&&(c=Ie(d.finish_reason)),d?.text!=null&&b.enqueue({type:"text-delta",textDelta:d.text});let T=Yt(d?.logprobs);T?.length&&(p===void 0&&(p=[]),p.push(...T))},flush(C){C.enqueue({type:"finish",finishReason:c,logprobs:p,usage:u})}})),rawCall:{rawPrompt:s,rawSettings:i},rawResponse:{headers:r},warnings:n,request:{body:JSON.stringify(o)}}}},xo=P.object({id:P.string().nullish(),created:P.number().nullish(),model:P.string().nullish(),choices:P.array(P.object({text:P.string(),finish_reason:P.string(),logprobs:P.object({tokens:P.array(P.string()),token_logprobs:P.array(P.number()),top_logprobs:P.array(P.record(P.string(),P.number())).nullable()}).nullish()})),usage:P.object({prompt_tokens:P.number(),completion_tokens:P.number()})}),bo=P.union([P.object({id:P.string().nullish(),created:P.number().nullish(),model:P.string().nullish(),choices:P.array(P.object({text:P.string(),finish_reason:P.string().nullish(),index:P.number(),logprobs:P.object({tokens:P.array(P.string()),token_logprobs:P.array(P.number()),top_logprobs:P.array(P.record(P.string(),P.number())).nullable()}).nullish()})),usage:P.object({prompt_tokens:P.number(),completion_tokens:P.number()}).nullish()}),tt]),To=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return(e=this.settings.maxEmbeddingsPerCall)!=null?e:2048}get supportsParallelCalls(){var e;return(e=this.settings.supportsParallelCalls)!=null?e:!0}async doEmbed({values:e,headers:t,abortSignal:n}){if(e.length>this.maxEmbeddingsPerCall)throw new Co({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});let{responseHeaders:o,value:r}=await V({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:Z(this.config.headers(),t),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:this.settings.dimensions,user:this.settings.user},failedResponseHandler:X,successfulResponseHandler:J(vo),abortSignal:n,fetch:this.config.fetch});return{embeddings:r.data.map(a=>a.embedding),usage:r.usage?{tokens:r.usage.prompt_tokens}:void 0,rawResponse:{headers:o}}}},vo=te.object({data:te.array(te.object({embedding:te.array(te.number())})),usage:te.object({prompt_tokens:te.number()}).nullish()}),Ao={"dall-e-3":1,"dall-e-2":10},wo=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1"}get maxImagesPerCall(){var e,t;return(t=(e=this.settings.maxImagesPerCall)!=null?e:Ao[this.modelId])!=null?t:1}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:n,aspectRatio:o,seed:r,providerOptions:a,headers:s,abortSignal:i}){var c,u,p,h;let C=[];o!=null&&C.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),r!=null&&C.push({type:"unsupported-setting",setting:"seed"});let b=(p=(u=(c=this.config._internal)==null?void 0:c.currentDate)==null?void 0:u.call(c))!=null?p:new Date,{value:y,responseHeaders:d}=await V({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:Z(this.config.headers(),s),body:{model:this.modelId,prompt:e,n:t,size:n,...(h=a.openai)!=null?h:{},response_format:"b64_json"},failedResponseHandler:X,successfulResponseHandler:J(So),abortSignal:i,fetch:this.config.fetch});return{images:y.data.map(T=>T.b64_json),warnings:C,response:{timestamp:b,modelId:this.modelId,headers:d}}}},So=Pe.object({data:Pe.array(Pe.object({b64_json:Pe.string()}))});function Ro({prompt:e,systemMessageMode:t}){let n=[],o=[];for(let{role:r,content:a}of e)switch(r){case"system":{switch(t){case"system":{n.push({role:"system",content:a});break}case"developer":{n.push({role:"developer",content:a});break}case"remove":{o.push({type:"other",message:"system messages are removed for this model"});break}default:{let s=t;throw new Error(`Unsupported system message mode: ${s}`)}}break}case"user":{n.push({role:"user",content:a.map((s,i)=>{var c,u,p,h;switch(s.type){case"text":return{type:"input_text",text:s.text};case"image":return{type:"input_image",image_url:s.image instanceof URL?s.image.toString():`data:${(c=s.mimeType)!=null?c:"image/jpeg"};base64,${ke(s.image)}`,detail:(p=(u=s.providerMetadata)==null?void 0:u.openai)==null?void 0:p.imageDetail};case"file":{if(s.data instanceof URL)throw new en({functionality:"File URLs in user messages"});switch(s.mimeType){case"application/pdf":return{type:"input_file",filename:(h=s.filename)!=null?h:`part-${i}.pdf`,file_data:`data:application/pdf;base64,${s.data}`};default:throw new en({functionality:"Only PDF files are supported in user messages"})}}}})});break}case"assistant":{for(let s of a)switch(s.type){case"text":{n.push({role:"assistant",content:[{type:"output_text",text:s.text}]});break}case"tool-call":{n.push({type:"function_call",call_id:s.toolCallId,name:s.toolName,arguments:JSON.stringify(s.args)});break}}break}case"tool":{for(let s of a)n.push({type:"function_call_output",call_id:s.toolCallId,output:JSON.stringify(s.result)});break}default:{let s=r;throw new Error(`Unsupported role: ${s}`)}}return{messages:n,warnings:o}}function tn({finishReason:e,hasToolCalls:t}){switch(e){case void 0:case null:return t?"tool-calls":"stop";case"max_output_tokens":return"length";case"content_filter":return"content-filter";default:return t?"tool-calls":"unknown"}}function _o({mode:e,strict:t}){var n;let o=(n=e.tools)!=null&&n.length?e.tools:void 0,r=[];if(o==null)return{tools:void 0,tool_choice:void 0,toolWarnings:r};let a=e.toolChoice,s=[];for(let c of o)switch(c.type){case"function":s.push({type:"function",name:c.name,description:c.description,parameters:c.parameters,strict:t?!0:void 0});break;case"provider-defined":switch(c.id){case"openai.web_search_preview":s.push({type:"web_search_preview",search_context_size:c.args.searchContextSize,user_location:c.args.userLocation});break;default:r.push({type:"unsupported-tool",tool:c});break}break;default:r.push({type:"unsupported-tool",tool:c});break}if(a==null)return{tools:s,tool_choice:void 0,toolWarnings:r};let i=a.type;switch(i){case"auto":case"none":case"required":return{tools:s,tool_choice:i,toolWarnings:r};case"tool":return a.toolName==="web_search_preview"?{tools:s,tool_choice:{type:"web_search_preview"},toolWarnings:r}:{tools:s,tool_choice:{type:"function",name:a.toolName},toolWarnings:r};default:{let c=i;throw new ko({functionality:`Unsupported tool choice type: ${c}`})}}}var Po=class{constructor(e,t){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.modelId=e,this.config=t}get provider(){return this.config.provider}getArgs({mode:e,maxTokens:t,temperature:n,stopSequences:o,topP:r,topK:a,presencePenalty:s,frequencyPenalty:i,seed:c,prompt:u,providerMetadata:p,responseFormat:h}){var C,b,y;let d=[],T=Ho(this.modelId),R=e.type;a!=null&&d.push({type:"unsupported-setting",setting:"topK"}),c!=null&&d.push({type:"unsupported-setting",setting:"seed"}),s!=null&&d.push({type:"unsupported-setting",setting:"presencePenalty"}),i!=null&&d.push({type:"unsupported-setting",setting:"frequencyPenalty"}),o!=null&&d.push({type:"unsupported-setting",setting:"stopSequences"});let{messages:L,warnings:j}=Ro({prompt:u,systemMessageMode:T.systemMessageMode});d.push(...j);let O=Jt({provider:"openai",providerOptions:p,schema:Uo}),f=(C=O?.strictSchemas)!=null?C:!0,x={model:this.modelId,input:L,temperature:n,top_p:r,max_output_tokens:t,...h?.type==="json"&&{text:{format:h.schema!=null?{type:"json_schema",strict:f,name:(b=h.name)!=null?b:"response",description:h.description,schema:h.schema}:{type:"json_object"}}},metadata:O?.metadata,parallel_tool_calls:O?.parallelToolCalls,previous_response_id:O?.previousResponseId,store:O?.store,user:O?.user,instructions:O?.instructions,...T.isReasoningModel&&O?.reasoningEffort!=null&&{reasoning:{effort:O?.reasoningEffort}},...T.requiredAutoTruncation&&{truncation:"auto"}};switch(T.isReasoningModel&&(x.temperature!=null&&(x.temperature=void 0,d.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),x.top_p!=null&&(x.top_p=void 0,d.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"}))),R){case"regular":{let{tools:A,tool_choice:w,toolWarnings:m}=_o({mode:e,strict:f});return{args:{...x,tools:A,tool_choice:w},warnings:[...d,...m]}}case"object-json":return{args:{...x,text:{format:e.schema!=null?{type:"json_schema",strict:f,name:(y=e.name)!=null?y:"response",description:e.description,schema:e.schema}:{type:"json_object"}}},warnings:d};case"object-tool":return{args:{...x,tool_choice:{type:"function",name:e.tool.name},tools:[{type:"function",name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:f}]},warnings:d};default:{let A=R;throw new Error(`Unsupported type: ${A}`)}}}async doGenerate(e){var t,n,o,r,a;let{args:s,warnings:i}=this.getArgs(e),{responseHeaders:c,value:u,rawValue:p}=await V({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:Z(this.config.headers(),e.headers),body:s,failedResponseHandler:X,successfulResponseHandler:J(g.object({id:g.string(),created_at:g.number(),model:g.string(),output:g.array(g.discriminatedUnion("type",[g.object({type:g.literal("message"),role:g.literal("assistant"),content:g.array(g.object({type:g.literal("output_text"),text:g.string(),annotations:g.array(g.object({type:g.literal("url_citation"),start_index:g.number(),end_index:g.number(),url:g.string(),title:g.string()}))}))}),g.object({type:g.literal("function_call"),call_id:g.string(),name:g.string(),arguments:g.string()}),g.object({type:g.literal("web_search_call")}),g.object({type:g.literal("computer_call")}),g.object({type:g.literal("reasoning")})])),incomplete_details:g.object({reason:g.string()}).nullable(),usage:on})),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=u.output.filter(b=>b.type==="message").flatMap(b=>b.content).filter(b=>b.type==="output_text"),C=u.output.filter(b=>b.type==="function_call").map(b=>({toolCallType:"function",toolCallId:b.call_id,toolName:b.name,args:b.arguments}));return{text:h.map(b=>b.text).join(`
`),sources:h.flatMap(b=>b.annotations.map(y=>{var d,T,R;return{sourceType:"url",id:(R=(T=(d=this.config).generateId)==null?void 0:T.call(d))!=null?R:B(),url:y.url,title:y.title}})),finishReason:tn({finishReason:(t=u.incomplete_details)==null?void 0:t.reason,hasToolCalls:C.length>0}),toolCalls:C.length>0?C:void 0,usage:{promptTokens:u.usage.input_tokens,completionTokens:u.usage.output_tokens},rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:c,body:p},request:{body:JSON.stringify(s)},response:{id:u.id,timestamp:new Date(u.created_at*1e3),modelId:u.model},providerMetadata:{openai:{responseId:u.id,cachedPromptTokens:(o=(n=u.usage.input_tokens_details)==null?void 0:n.cached_tokens)!=null?o:null,reasoningTokens:(a=(r=u.usage.output_tokens_details)==null?void 0:r.reasoning_tokens)!=null?a:null}},warnings:i}}async doStream(e){let{args:t,warnings:n}=this.getArgs(e),{responseHeaders:o,value:r}=await V({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:Z(this.config.headers(),e.headers),body:{...t,stream:!0},failedResponseHandler:X,successfulResponseHandler:ae(No),abortSignal:e.abortSignal,fetch:this.config.fetch}),a=this,s="unknown",i=NaN,c=NaN,u=null,p=null,h=null,C={},b=!1;return{stream:r.pipeThrough(new TransformStream({transform(y,d){var T,R,L,j,O,f,x,A;if(!y.success){s="error",d.enqueue({type:"error",error:y.error});return}let w=y.value;if(Zo(w))w.item.type==="function_call"&&(C[w.output_index]={toolName:w.item.name,toolCallId:w.item.call_id},d.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:w.item.call_id,toolName:w.item.name,argsTextDelta:w.item.arguments}));else if(Fo(w)){let m=C[w.output_index];m!=null&&d.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:m.toolCallId,toolName:m.toolName,argsTextDelta:w.delta})}else Wo(w)?(h=w.response.id,d.enqueue({type:"response-metadata",id:w.response.id,timestamp:new Date(w.response.created_at*1e3),modelId:w.response.model})):$o(w)?d.enqueue({type:"text-delta",textDelta:w.delta}):zo(w)&&w.item.type==="function_call"?(C[w.output_index]=void 0,b=!0,d.enqueue({type:"tool-call",toolCallType:"function",toolCallId:w.item.call_id,toolName:w.item.name,args:w.item.arguments})):qo(w)?(s=tn({finishReason:(T=w.response.incomplete_details)==null?void 0:T.reason,hasToolCalls:b}),i=w.response.usage.input_tokens,c=w.response.usage.output_tokens,u=(L=(R=w.response.usage.input_tokens_details)==null?void 0:R.cached_tokens)!=null?L:u,p=(O=(j=w.response.usage.output_tokens_details)==null?void 0:j.reasoning_tokens)!=null?O:p):Vo(w)&&d.enqueue({type:"source",source:{sourceType:"url",id:(A=(x=(f=a.config).generateId)==null?void 0:x.call(f))!=null?A:B(),url:w.annotation.url,title:w.annotation.title}})},flush(y){y.enqueue({type:"finish",finishReason:s,usage:{promptTokens:i,completionTokens:c},...(u!=null||p!=null)&&{providerMetadata:{openai:{responseId:h,cachedPromptTokens:u,reasoningTokens:p}}}})}})),rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:o},request:{body:JSON.stringify(t)},warnings:n}}},on=g.object({input_tokens:g.number(),input_tokens_details:g.object({cached_tokens:g.number().nullish()}).nullish(),output_tokens:g.number(),output_tokens_details:g.object({reasoning_tokens:g.number().nullish()}).nullish()}),Io=g.object({type:g.literal("response.output_text.delta"),delta:g.string()}),Oo=g.object({type:g.enum(["response.completed","response.incomplete"]),response:g.object({incomplete_details:g.object({reason:g.string()}).nullish(),usage:on})}),Eo=g.object({type:g.literal("response.created"),response:g.object({id:g.string(),created_at:g.number(),model:g.string()})}),Mo=g.object({type:g.literal("response.output_item.done"),output_index:g.number(),item:g.discriminatedUnion("type",[g.object({type:g.literal("message")}),g.object({type:g.literal("function_call"),id:g.string(),call_id:g.string(),name:g.string(),arguments:g.string(),status:g.literal("completed")})])}),jo=g.object({type:g.literal("response.function_call_arguments.delta"),item_id:g.string(),output_index:g.number(),delta:g.string()}),Lo=g.object({type:g.literal("response.output_item.added"),output_index:g.number(),item:g.discriminatedUnion("type",[g.object({type:g.literal("message")}),g.object({type:g.literal("function_call"),id:g.string(),call_id:g.string(),name:g.string(),arguments:g.string()})])}),Do=g.object({type:g.literal("response.output_text.annotation.added"),annotation:g.object({type:g.literal("url_citation"),url:g.string(),title:g.string()})}),No=g.union([Io,Oo,Eo,Mo,jo,Lo,Do,g.object({type:g.string()}).passthrough()]);function $o(e){return e.type==="response.output_text.delta"}function zo(e){return e.type==="response.output_item.done"}function qo(e){return e.type==="response.completed"||e.type==="response.incomplete"}function Wo(e){return e.type==="response.created"}function Fo(e){return e.type==="response.function_call_arguments.delta"}function Zo(e){return e.type==="response.output_item.added"}function Vo(e){return e.type==="response.output_text.annotation.added"}function Ho(e){return e.startsWith("o")?e.startsWith("o1-mini")||e.startsWith("o1-preview")?{isReasoningModel:!0,systemMessageMode:"remove",requiredAutoTruncation:!1}:{isReasoningModel:!0,systemMessageMode:"developer",requiredAutoTruncation:!1}:{isReasoningModel:!1,systemMessageMode:"system",requiredAutoTruncation:!1}}var Uo=g.object({metadata:g.any().nullish(),parallelToolCalls:g.boolean().nullish(),previousResponseId:g.string().nullish(),store:g.boolean().nullish(),user:g.string().nullish(),reasoningEffort:g.string().nullish(),strictSchemas:g.boolean().nullish(),instructions:g.string().nullish()}),Bo=Jo.object({});function Go({searchContextSize:e,userLocation:t}={}){return{type:"provider-defined",id:"openai.web_search_preview",args:{searchContextSize:e,userLocation:t},parameters:Bo}}var Ko={webSearchPreview:Go};function Xo(e={}){var t,n,o;let r=(t=Gt(e.baseURL))!=null?t:"https://api.openai.com/v1",a=(n=e.compatibility)!=null?n:"compatible",s=(o=e.name)!=null?o:"openai",i=()=>({Authorization:`Bearer ${Ht({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers}),c=(d,T={})=>new co(d,T,{provider:`${s}.chat`,url:({path:R})=>`${r}${R}`,headers:i,compatibility:a,fetch:e.fetch}),u=(d,T={})=>new ho(d,T,{provider:`${s}.completion`,url:({path:R})=>`${r}${R}`,headers:i,compatibility:a,fetch:e.fetch}),p=(d,T={})=>new To(d,T,{provider:`${s}.embedding`,url:({path:R})=>`${r}${R}`,headers:i,fetch:e.fetch}),h=(d,T={})=>new wo(d,T,{provider:`${s}.image`,url:({path:R})=>`${r}${R}`,headers:i,fetch:e.fetch}),C=(d,T)=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return d==="gpt-3.5-turbo-instruct"?u(d,T):c(d,T)},b=d=>new Po(d,{provider:`${s}.responses`,url:({path:T})=>`${r}${T}`,headers:i,fetch:e.fetch}),y=function(d,T){return C(d,T)};return y.languageModel=C,y.chat=c,y.completion=u,y.responses=b,y.embedding=p,y.textEmbedding=p,y.textEmbeddingModel=p,y.image=h,y.imageModel=h,y.tools=Ko,y}var rn=Xo({compatibility:"strict"});import{z as Ee}from"zod";import{v7 as Yo}from"uuid";var Me=typeof window<"u"&&typeof window.document<"u",G,sn;if(!Me)try{G=pt("fs"),sn=pt("path")}catch{console.warn("File system modules not available in this environment")}var er=async(e,t,n,o)=>{let r=await Qo({model:e.memory.vectorModel||rn("gpt-4-turbo"),schema:Ee.object({observation:Ee.string().describe("The context and setup - what happened"),thoughts:Ee.string().describe("Internal reasoning process and observations of the agent in the episode that let it arrive at the correct action and result. 'I ...'"),result:Ee.string().describe("Outcome and retrospective. What did you do well? What could you do better next time? I ...")}),prompt:`
    You are creating an episodic memory for an AI agent to help it recall and learn from past experiences.
    
    Your task is to analyze the agent's thoughts, actions, and the results of those actions to create a structured memory that can be used for future reference and learning.

    ## Context
    <thoughts>
    ${JSON.stringify(t)}
    </thoughts>

    ## Actions Taken
    <actions>
    ${JSON.stringify(n)}
    </actions>

    ## Results & Outcomes
    <results>
    ${JSON.stringify(o)}
    </results>
    
    ## Instructions
    Create a comprehensive episodic memory with these components:
    
    1. OBSERVATION: Provide a clear, concise description of the situation, context, and key elements. Include:
       - What was the environment or scenario?
       - What was the agent trying to accomplish?
       - What were the initial conditions or constraints?
    
    2. THOUGHTS: Capture the agent's internal reasoning process that led to its actions:
       - What was the agent's understanding of the situation?
       - What strategies or approaches did it consider?
       - What key insights or realizations occurred during the process?
       - Use first-person perspective ("I realized...", "I considered...")
    
    3. RESULT: Summarize the outcomes and provide a retrospective analysis:
       - What was accomplished or not accomplished?
       - What worked well and what didn't?
       - What lessons can be learned for future similar situations?
       - What would be done differently next time?
       - Use first-person perspective ("I succeeded in...", "Next time I would...")
    
    Make the memory detailed enough to be useful for future recall, but concise enough to be quickly processed. Focus on capturing the essence of the experience, key decision points, and lessons learned.`});return{observation:r.object.observation,thoughts:r.object.thoughts,result:r.object.result}};function tr(e){let t=e.observation,n=`${e.thoughts}

${e.result}`;return{prompt:t,completion:n}}async function an(e,t){if(Me){console.warn("saveTrainingData is not supported in browser environments");return}try{if(!G){console.warn("File system module not available");return}let n=sn.dirname(t);G.existsSync(n)||G.mkdirSync(n,{recursive:!0});let o=e.map(r=>JSON.stringify(r)).join(`
`);G.writeFileSync(t,o,"utf8")}catch(n){throw console.error("Error saving training data:",n),n}}async function nr(e,t,n,o,r){let a=await er(o,e,t,n);if(r?.exportTrainingData&&!Me&&G){let s=tr(a),i=r.trainingDataPath||"./training-data.jsonl",c=[];G.existsSync(i)&&(c=G.readFileSync(i,"utf8").split(`
`).filter(p=>p.trim()!=="").map(p=>JSON.parse(p))),c.push(s),await an(c,i)}return{id:Yo(),timestamp:Date.now(),observation:a.observation,result:a.result,thoughts:a.thoughts}}async function cn(e,t="./training-data.jsonl"){if(Me){console.warn("exportEpisodesAsTrainingData is not supported in browser environments");return}if(!G){console.warn("File system module not available");return}let n=e.map(o=>({prompt:o.observation,completion:`${o.thoughts}

${o.result}`}));await an(n,t)}async function un(e,t,n,o,r,a){let s=a.find(h=>h.name===t.name);if(!s)return;let p=await nr([e],[s],[n],o,{exportTrainingData:o.exportTrainingData===!0,trainingDataPath:o.trainingDataPath||"./training-data.jsonl"});await o.memory.vector.upsert(`${r}`,[{id:p.id,text:p.observation,metadata:p}])}function or(e){return new RegExp(`(<${e}(?:\\s+[^>]*)?>)([\\s\\S]*?)</${e}>`,"gs")}function pa(e,t){let n=or(e);return o=>{let r=Array.from(o.matchAll(n));try{return r.map(a=>({tag:e,params:a[1]?ot(a[1]):{},content:t?t(a[2]?.trim()):a[2]?.trim()}))}catch(a){throw a}}}function ot(e){let t={};if(e.length===0)return t;let n=e.matchAll(/(\w+)="([^"]*)"/g);for(let o of n)t[o[1]]=o[2];return t}function rt(e,t,n=0,o=void 0){let r=[],a=e.trim();for(;a.length>0;){let s=a.indexOf("<");if(s===-1){let R={type:"text",content:a.trim()};r.push(t(R,()=>[]));break}let i=a.indexOf(">",s);if(s>0||i===-1){let R={type:"text",content:a.slice(0,i===-1?-1:s).trim()};r.push(t(R,()=>[]))}if(i===-1)break;let c=a.slice(s+1,i),u=!1;c.at(-1)==="/"&&(u=!0,c=c.slice(0,-1));let[p,...h]=c.split(" "),C=ot(h.join(" ").trim());if(u){a=a.slice(i+1).trim(),r.push(t({type:"element",name:p,attributes:C,content:"",closed:u},()=>[]));continue}let b=`</${p}>`,y=a.indexOf(b);if(y===-1)break;let d=a.slice(i+1,y).trim(),T={type:"element",name:p,attributes:C,content:d};o&&(T.parent=o),r.push(t(T,()=>rt(d,t,n+1,T))),a=a.slice(y+b.length).trim()}return r}function da(e){return e.type==="element"}function ma(e){return e.type==="text"}var rr=/[a-zA-Z\/]/,nt=["'","`",'"',"(",")"];function*ln(e,t){let n="",o="",r="";for(;;){let a=yield;if(a){for(n+=a;n.length>0;){let s=n.indexOf("<");if(s===0&&r&&nt.includes(r.at(-1))){o+=n[0],n=n.slice(1);continue}if(s>0){nt.includes(n[s-1])?(o+=n.slice(0,s+1),n=n.slice(s+1)):(o+=n.slice(0,s),n=n.slice(s)),o.length>0&&(yield{type:"text",content:o},r=o,o="");continue}if(s===-1||n.length>1&&!rr.test(n[s+1])){o+=n,n="";break}let i=n.indexOf(">",s);if(i===-1||n.length===i)break;if(nt.includes(n[i+1])){o+=n.slice(0,i+1),n=n.slice(i+1),o.length>0&&(yield{type:"text",content:o},r=o,o="");break}let c=n.slice(s+1,i),u=c.startsWith("/"),p=u?c.slice(1).trim().split(" ")[0]:c.trim().split(" ")[0];if(e.has(p)&&t(p,u))if(o.length>0&&(yield{type:"text",content:o},r=o,o=""),u)yield{type:"end",name:p};else{let h=ot(c.slice(p.length));yield{type:"start",name:p,attributes:h}}else o+=n.slice(0,i+1);n=n.slice(i+1)}o.length>0&&(yield{type:"text",content:o},r=o,o="")}}}import ar from"p-defer";async function pn(e,t,n,o,r){let a,s=[],i=t,c=ln(n,(p,h)=>{if(a?.tag===p&&!h&&p==="think"||a?.tag===p&&!h&&p==="response"||a?.tag===p&&!h&&p==="reasoning")return!1;if(a?.tag===p&&!h)return a._depth++,!1;if(a?.tag===p&&h)return a._depth>0?(a._depth--,!1):!0;if(a===void 0||a?.tag==="response")return!0;if(h&&s.length>0){let C=s.findIndex(y=>y.tag===p);if(C===-1)return!1;a&&(o({...a,done:!0},r),a=void 0);let b=s.splice(C+1).reverse();for(let y of b)o({...y,done:!0},r);return a=s.pop(),!0}return!1});c.next();function u(p){let h=c.next(p);for(;!h.done&&h.value;)h.value.type==="start"&&(a&&s.push(a),a={index:i++,tag:h.value.name,attributes:h.value.attributes,content:"",done:!1,_depth:0},o(a,r)),h.value.type==="end"&&(a&&o({...a,done:!0},r),a=s.pop()),h.value.type==="text"&&a&&(a.content+=h.value.content,o(a,r)),h=c.next()}for await(let p of e)u(p);c.return?.()}async function*dn(e,t,n){yield t;for await(let o of e)yield o;yield n}var ir=new Set(["think","thinking","response","output","action_call","reasoning"]);function mn({agent:e,ctxState:t,agentCtxState:n,logger:o,handlers:r,taskRunner:a,workingMemory:s,stepConfig:i,abortSignal:c,subscriptions:u}){let p={id:U(),ref:"run",type:t.context.type,data:{},processed:!1,timestamp:Date.now()};async function h(){let f={ref:"step",id:U(),step:b.step,type:i.name,data:{},processed:!1,timestamp:Date.now()};return b.steps.push(f),s.steps.push(f),await j(f,!0),f}async function C(){let{actions:f,contexts:x,outputs:A,inputs:w}=await Dt({agent:e,ctxState:t,workingMemory:s,agentCtxState:n,params:b.params});Object.assign(b,{actions:f,contexts:x,outputs:A,inputs:w})}let b={index:0,logsByIndex:new Map,step:0,ctxState:t,agentCtxState:n,runRef:p,controller:new AbortController,steps:[],chain:[],actions:[],outputs:[],inputs:[],contexts:[],errors:[],calls:[],promises:[],response:null,defer:ar(),params:{},async setParams(f){b.params=f},async start(){return await C(),await j(p,!0),b.step=1,h()},async nextStep(){return await C(),b.index++,h()},shouldContinue(){b.errors.length>0&&o.warn("agent:run","Continuing despite error",{errors:b.errors,step:b.step});for(let f of b.contexts)if(f.context.shouldContinue&&f.context.shouldContinue({...f,workingMemory:s}))return!0;return i.shouldContinue({chain:b.chain})}};c?.addEventListener("abort",()=>{b.controller.abort(c?.reason)});function y({name:f,data:x,params:A}){return{ref:"event",id:U(),name:f,data:x,params:A,processed:!1,timestamp:Date.now()}}s.runs.push(p);function d(f,x){return b.logsByIndex.has(f)||b.logsByIndex.set(f,{id:U(),timestamp:Date.now(),processed:!1,...x}),b.index=Math.max(f,b.index),b.logsByIndex.get(f)}async function T(f,x){if(f.ref!=="output"&&x&&b.chain.push(f),f.ref==="thought"&&x&&(s.thoughts.push(f),o.debug("agent:think","thought",f.content),r?.onThinking?.(f)),f.ref==="input"&&x&&(await Nt({agent:e,ctxState:t,inputRef:f,inputs:{...e.inputs,...t.context.inputs},logger:o,workingMemory:s}),b.chain.push(f),s.inputs.push(f)),f.ref==="output"&&x&&await L(f),f.ref==="event"&&x&&s.events.push(f),f.ref==="action_call"&&x&&(s.calls.push(f),await R(f)),f.ref==="action_result"&&x){s.results.push(f);let A=s.thoughts[s.thoughts.length-1],w=s.calls[s.calls.length-1];A&&w&&e.memory.generateMemories&&await un(A,w,f,e,t.id,b.actions).catch(m=>{o.error("agent:generateEpisode","Failed to generate episode",m)})}x&&await re(e,t.id,s);try{r?.onLogStream?.(f,x)}catch{}for(let A of u)try{A(f,x)}catch{}}async function R(f){let{action:x,json:A,templates:w}=await Et({call:f,actions:b.actions,logger:o});if(!c?.aborted){if(w.length>0&&await Ot(A,w,async function(l,_){if(l==="calls"){let[E,...k]=Ve(_),I=Te(b.calls,[E]);if(!I)throw new Error("invalid callIndex");console.log("waiting for call to finish");let W=await I;console.log({resultPath:k,results:W,calls:b.calls});let N=Te(W.data,k);if(N===void 0)throw new Error("invalid resultPath");return N}if(l==="shortTermMemory"){let E=b.contexts.find(I=>I.context.type==="shortTermMemory");if(!E)throw new Error("short term memory not found");let k=It(E.memory,_);if(k===void 0)throw new Error("invalid short term memory resultPath");return k}throw new Error("not implemented")}),x.schema){let m="parse"in x.schema||"validate"in x.schema?x.schema:sr.object(x.schema);f.data="parse"in m?m.parse(A):m.validate?m.validate(A):A}else f.data=A;b.calls.push(Mt({call:f,action:x,agent:e,logger:o,state:b.contexts.find(m=>m.id===x.ctxId)??t,taskRunner:a,workingMemory:s,agentState:n,abortSignal:c,pushLog:m=>j(m,!0)}).catch(m=>({ref:"action_result",id:U(),callId:f.id,data:{error:JSON.stringify(m)},name:f.name,timestamp:Date.now(),processed:!1})).then(m=>(j(m,!0),m)))}}async function L(f){o.debug("agent:output",f.type,f.data);let x=await jt({agent:e,logger:o,state:t,workingMemory:s,outputs:b.outputs,outputRef:f});for(let A of Array.isArray(x)?x:[x])o.debug("agent:output","Output processed status",{type:A.type,processed:A.processed}),b.chain.push(A),s.outputs.push(A)}async function j(f,x){try{await T(f,x)}catch(A){if(b.errors.push(A),f.ref==="input")return;if(A instanceof Y){if(A.ref.ref==="input")return;if(A.ref.ref==="output"){let w={...A.ref,params:{...A.ref.params,id:A.ref.id,error:"OutputTypeNotFound"},processed:!1};b.chain.push(w),s.outputs.push(w)}await T(y({name:`error:${A.ref.ref}`,data:A.ref.ref==="output"?{error:"OutputTypeNotFound",type:A.ref.type??"undefined"}:{error:"ActionNameNotFound",name:A.ref.name},params:A.ref.ref==="output"?{outputId:A.ref.id}:{callId:A.ref.id}}),!0)}A instanceof ee&&(A.ref.ref==="output"&&T({...A.ref,params:{id:A.ref.id,error:"parsingError"}},!0),T(y({name:`error:${A.ref.ref}:parsingError`,data:A.parsingError,params:A.ref.ref==="output"?{outputId:A.ref.id}:{callId:A.ref.id}}),!0))}}function O(f,x){if(!c?.aborted)switch(f.tag){case"think":case"thinking":case"reasoning":{let A=d(f.index,{ref:"thought"});j({...A,content:f.content},f.done);break}case"action_call":{let A=d(f.index,{ref:"action_call"});j({...A,name:f.attributes.name,content:f.content,data:void 0,processed:!1},f.done);break}case"output":{let A=d(f.index,{ref:"output"}),{type:w,...m}=f.attributes;j({...A,type:w,params:m,content:f.content,data:void 0},f.done);break}default:break}}return{state:b,handler:O,push:j,tags:ir,stepConfig:i}}var je={"o3-mini":{assist:!1,prefix:""},"claude-3-7-sonnet-20250219":{},"qwen-qwq-32b":{prefix:""},"google/gemini-2.0-flash-001":{},"deepseek-r1-distill-llama-70b":{prefix:"",assist:!1}},ur=["claude-3-7-sonnet-20250219","qwen-qwq-32b","deepseek-r1-distill-llama-70b","o3-mini","google/gemini-2.0-flash-001","google/gemini-2.0-flash-lite-preview-02-05:free"];function lr({model:e,stream:t,isReasoningModel:n}){let o=je[e.modelId]?.prefix??(n?je[e.modelId]?.thinkTag??"<think>":"<response>"),r="</response>";return{getTextResponse:async()=>{let a=await t.text;return o+a+r},stream:dn(t.textStream,o,r)}}var gn=$e("agent:run:generate",async({prompt:e,workingMemory:t,model:n,onError:o,abortSignal:r},{callId:a,debug:s})=>{let i=ur.includes(n.modelId),c=[{role:"user",content:[{type:"text",text:e}]}];je[n.modelId]?.assist!==!1&&c.push({role:"assistant",content:i?je[n.modelId]?.thinkTag??"<think>":"<response>"}),t.currentImage&&(c[0].content=[...c[0].content,{type:"image",image:t.currentImage}]);try{let u=cr({model:n,messages:c,stopSequences:[`
</response>`],temperature:.6,abortSignal:r,onError:p=>{console.log({event:p}),o(p.error)}});return lr({model:n,stream:u,isReasoningModel:i})}catch(u){throw console.log({error:u}),u}}),$t=$e("agent:run:action",async({ctx:e,action:t,agent:n,logger:o})=>{o.info("agent:action_call:"+e.call.id,e.call.name,JSON.stringify(e.call.data));try{let r=t.schema===void 0?await Promise.try(t.handler,e,n):await Promise.try(t.handler,e.call.data,e,n);return o.debug("agent:action_result:"+e.call.id,e.call.name,r),r}catch(r){if(o.error("agent:action","ACTION_FAILED",{error:r}),t.onError)await Promise.try(t.onError,r,e,n);else throw r}});var pr={intro:`  You are tasked with analyzing inputs, formulating outputs, and initiating actions based on the given contexts. 
  You will be provided with a set of available actions, outputs, and contexts. 
  Your instructions are to analyze the situation and respond appropriately.`,instructions:`Follow these steps to process the updates:

1. Analyze the updates and available data:
   Wrap your reasoning process in <reasoning> tags. Consider:

   - Check the available data to avoid redundant action calls
   - The availabe contexts and their state
   - The available actions and their asynchronous nature
   - The content of the new updates
   - Potential dependencies between actions

   Response determination guidelines:

   a) First check if required state exists in the available contexts
   b) Respond to direct questions or requests for information

2. Plan actions:
   Before formulating a response, consider:

   - What data is already available
   - Which actions need to be initiated
   - The order of dependencies between actions
   - How to handle potential action failures
   - What information to provide while actions are processing

3. Formulate a output (if needed):
   If you decide to respond to the message, use <output> tags to enclose your output.
   Consider:

   - Using available data when possible
   - Acknowledging that certain information may not be immediately available
   - Setting appropriate expectations about action processing time
   - Indicating what will happen after actions complete
   - You can only use outputs listed in the <available_outputs> section
   - Follow the schemas provided for each output
  
4. Initiate actions (if needed):
   Use <action_call> tags to initiate actions. Remember:

   - Actions are processed asynchronously after your response
   - Results will not be immediately available
   - You can only use actions listed in the <available_actions> section
   - Follow the schemas provided for each action
   - Actions should be used when necessary to fulfill requests or provide information that cannot be conveyed through a simple response

5. No output or action:
   If you determine that no output or action is necessary, don't respond to that message.`,content:`Here are the available actions you can initiate:
{{actions}}

Here are the available outputs you can use:
{{outputs}}

Here is the current contexts:
{{contexts}}

<template-engine>
Purpose: Utilize the template engine ({{...}} syntax) primarily to streamline workflows by transferring data between different components within the same turn. This includes passing outputs from actions into subsequent action arguments, or embedding data from various sources directly into response outputs. This enhances efficiency and reduces interaction latency.

Data Referencing: You can reference data from:
Action Results: Use {{calls[index].path.to.value}} to access outputs from preceding actions in the current turn (e.g., {{calls[0].sandboxId}}). Ensure the index correctly points to the intended action call.
Short-Term Memory: Retrieve values stored in short-term memory using {{shortTermMemory.key}}

When to Use:
Data Injection: Apply templating when an action argument or a response output requires specific data (like an ID, filename, status, or content) from an action result, configuration, or short-term memory available within the current turn.
Direct Dependencies: Particularly useful when an action requires a specific result from an action called immediately before it in the same turn.
</template-engine>

Here is the current working memory:
{{workingMemory}}

Now, analyze the following updates:
{{updates}}`,response:`Here's how you structure your response:
<response>
<reasoning>
[Your reasoning of the context, think, messages, and planned actions]
</reasoning>

[List of async action calls to be initiated, if applicable]
<action_call name="[Action name]">[action arguments using the schema as JSON]</action_call>

[List of outputs, if applicable]
<output type="[Output type]" {...output attributes using the schema}>
[output content using the content_schema]
</output>
</response>`,footer:`Remember:
- Always correlate results with their original actions using callId
- Never repeat your outputs
- Consider the complete chain of events when formulating responses
- Address any failures or unexpected results explicitly
- Initiate follow-up actions only when necessary
- Provide clear, actionable insights based on the combined results
- Maintain context awareness between original request and final results

IMPORTANT: 
Always include the 'type' attribute in the output tag and ensure it matches one of the available output types listed above.
Remember to include the other attribute in the output tag and ensure it matches the output attributes schema.
If you say you will perform an action, you MUST issue the corresponding action call here`},st=`{{intro}}

{{instructions}}

{{content}}

{{response}}

{{footer}}
`;function dr({contexts:e,outputs:t,actions:n,workingMemory:o,maxWorkingMemorySize:r,chainOfThoughtSize:a}){return{actions:D("available-actions",void 0,n.map(bt)),outputs:D("available-outputs",void 0,t.map(xt)),contexts:D("contexts",void 0,e.map(Ct)),workingMemory:D("working-memory",void 0,We({memory:o,size:r,processed:!0})),thoughts:D("thoughts",void 0,o.thoughts.map(s=>xe(s)).slice(-(a??5))),updates:D("updates",void 0,We({memory:o,processed:!1}))}}var Le={name:"main",template:st,sections:pr,render:e=>{let t=Object.fromEntries(Object.entries(Le.sections).map(([o,r])=>[o,ue(r,e)]));return ue(Le.template,t)},formatter:dr,shouldContinue:e=>e.chain.filter(n=>n.ref!=="thought"&&n.processed===!1).length>0};function Ua(e){let t=!1,n=new Map,o=new Set,r=new Map,a=new Map,s=new Map,i=new Map,c={contexts:new Map,actions:new Map,outputs:new Map,inputs:new Map,extensions:new Map,models:new Map,prompts:new Map};c.prompts.set("step",st);let{inputs:u={},outputs:p={},events:h={},actions:C=[],experts:b={},services:y=[],extensions:d=[],model:T,reasoningModel:R,exportTrainingData:L,trainingDataPath:j}=e,O=e.container??dt(),f=e.taskRunner??new fe(3),x=new ge({level:e.logger??2,enableTimestamp:!0,enableColors:!0});O.instance("logger",x),x.debug("dreams","Creating agent",{hasModel:!!T,hasReasoningModel:!!R,inputsCount:Object.keys(u).length,outputsCount:Object.keys(p).length,actionsCount:C.length,servicesCount:y.length,extensionsCount:d.length});let A=(...l)=>{if(e.debugger)try{e.debugger(...l)}catch{console.log("debugger failed")}},w=mt(O);for(let l of y)w.register(l);if(e.contexts)for(let l of e.contexts)c.contexts.set(l.type,l);for(let l of d){if(l.inputs&&Object.assign(u,l.inputs),l.outputs&&Object.assign(p,l.outputs),l.events&&Object.assign(h,l.events),l.actions&&C.push(...l.actions),l.services)for(let _ of l.services)w.register(_);if(l.contexts)for(let _ of Object.values(l.contexts))c.contexts.set(_.type,_)}let m={inputs:u,outputs:p,events:h,actions:C,experts:b,memory:e.memory??Rt(kt(),_t()),container:O,model:T,reasoningModel:R,taskRunner:f,debugger:A,context:e.context??void 0,exportTrainingData:L,trainingDataPath:j,registry:c,emit:(l,_)=>{x.debug("agent:event",l,_)},isBooted(){return t},subscribeContext(l,_){i.has(l)||i.set(l,new Set);let E=i.get(l);if(E.has(_))throw new Error("handler already registered");return E.add(_),()=>{E.delete(_)}},async getContexts(){return wt(o,r)},async getContextById(l){if(r.has(l))return r.get(l);let[_]=l.split(":"),E=c.contexts.get(_);if(E&&o.has(l)){let k=await Ce(m,E,l);if(k){let I=await le({agent:m,context:E,args:k.args,settings:k.settings,contexts:k.contexts});return await this.saveContext(I),I}}return null},async getContext(l){c.contexts.has(l.context.type)||c.contexts.set(l.context.type,l.context);let E=("parse"in l.context.schema?l.context.schema:fn.object(l.context.schema)).parse(l.args),k=be(l.context,E);if(!r.has(k)&&o.has(k)){let I=await Ce(m,l.context,k);I&&await this.saveContext(await le({agent:m,context:l.context,args:l.args,settings:I.settings,contexts:I.contexts}))}return r.has(k)||await this.saveContext(await le({agent:m,context:l.context,args:l.args})),r.get(k)},async loadContext(l){c.contexts.has(l.context.type)||c.contexts.set(l.context.type,l.context);let E=("parse"in l.context.schema?l.context.schema:fn.object(l.context.schema)).parse(l.args),k=be(l.context,E);if(!r.has(k)&&o.has(k)){console.log({id:k});let I=await Ce(m,l.context,k);I&&await this.saveContext(await le({agent:m,context:l.context,args:l.args,settings:I.settings,contexts:I.contexts}))}return r.get(k)??null},async saveContext(l,_){return o.add(l.id),r.set(l.id,l),await At(m,l),_&&(s.set(l.id,_),await re(m,l.id,_)),await Fe(m,o),!0},getContextId(l){return x.trace("agent:getContextId","Getting context id",l),be(l.context,l.args)},async getWorkingMemory(l){return x.trace("agent:getWorkingMemory","Getting working memory",{contextId:l}),s.has(l)||s.set(l,await vt(m,l)),s.get(l)},async deleteContext(l){r.delete(l),o.delete(l),a.delete(l),s.delete(l),await St(m,l),await Fe(m,o)},async start(l){if(t)return m;x.info("agent:start","Starting agent",{args:l,booted:t}),t=!0,x.debug("agent:start","Booting services"),await w.bootAll(),x.debug("agent:start","Installing extensions",{count:d.length});for(let k of d)k.install&&await oe(k.install,m);x.debug("agent:start","Setting up inputs",{count:Object.keys(m.inputs).length});let _={...m.inputs};for(let k of c.contexts.values())k.inputs&&Object.assign(_,k.inputs);for(let[k,I]of Object.entries(_))if(I.install&&(x.trace("agent:start","Installing input",{type:k}),await oe(I.install,m)),I.subscribe){x.trace("agent:start","Subscribing to input",{type:k});let W=await oe(I.subscribe,(N,z,M)=>{x.debug("agent","input",{context:N,args:z,data:M}),m.send({context:N,input:{type:k,data:M},args:z}).catch(H=>{x.error("agent:input","error",H)})},m);W&&n.set(k,W)}x.debug("agent:start","Setting up outputs",{count:Object.keys(p).length});for(let[k,I]of Object.entries(p))I.install&&(x.trace("agent:start","Installing output",{type:k}),await oe(I.install,m));x.debug("agent:start","Setting up actions",{count:C.length});for(let k of C)k.install&&(x.trace("agent:start","Installing action",{name:k.name}),await oe(k.install,m));x.debug("agent:start","Loading saved contexts");let E=await m.memory.store.get("contexts");if(E){x.trace("agent:start","Restoring saved contexts",{count:E.length});for(let k of E)o.add(k)}if(m.context){x.debug("agent:start","Setting up agent context",{type:m.context.type});let k=await m.getContext({context:m.context,args:l});r.set("agent:context",k)}return x.info("agent:start","Agent started successfully"),m},async stop(){x.info("agent:stop","Stopping agent")},async run(l){let{context:_,args:E,outputs:k,handlers:I,abortSignal:W}=l;if(console.log(l.chain),!t)throw x.error("agent:run","Agent not booted"),new Error("Not booted");x.info("agent:run","Running context",{contextType:_.type,hasArgs:!!E,hasCustomOutputs:!!k,hasHandlers:!!I});let N=m.getContextId({context:_,args:E}),z=await m.getContext({context:_,args:E}),M=await m.getWorkingMemory(N),H=r.get("agent:context"),$=m.context&&H?await m.getContext({context:m.context,args:H.args}):void 0;if(a.has(N)){x.debug("agent:run","Context already running",{id:N});let{state:q,push:Q}=a.get(N);return l.chain?.forEach(ce=>Q(ce,!0)),q.defer.promise}x.debug("agent:run","Added context to running set",{id:N}),i.has(N)||i.set(N,new Set);let{state:S,handler:at,push:it,tags:ct,stepConfig:Ne}=mn({agent:m,agentCtxState:$,ctxState:z,handlers:I,logger:x,taskRunner:f,workingMemory:M,abortSignal:W,stepConfig:Le,subscriptions:i.get(N)});a.set(N,{state:S,handler:at,push:it,tags:ct,stepConfig:Ne});let ut=0;function yn(){return z.settings.maxSteps??5}await S.setParams({actions:l.actions,outputs:l.outputs,contexts:l.contexts}),l.chain&&await Promise.all(l.chain.map(q=>it(q,!0))),S.calls.length>0&&(await Promise.allSettled(S.calls),S.calls.length=0);let de=await S.start(),hn=l.model??_.model??e.reasoningModel??e.model;for(;(ut=yn())>=S.step;){x.info("agent:run",`Starting step ${S.step}/${ut}`,{contextId:z.id});try{S.step>1&&(de=await S.nextStep());let q=Ne.formatter({contexts:S.contexts,actions:S.actions,outputs:S.outputs,workingMemory:M,chainOfThoughtSize:0,maxWorkingMemorySize:z.settings.maxWorkingMemorySize}),Q=Ne.render(q);de.data.prompt=Q;let ce=null,xn=[...M.inputs.filter(F=>F.processed===!1),...S.chain.filter(F=>F.processed===!1)],{stream:bn,getTextResponse:Cn}=await f.enqueueTask(gn,{model:hn,prompt:Q,workingMemory:M,logger:x,abortSignal:W,onError:F=>{ce=F,S.errors.push(F)}},{debug:m.debugger,abortSignal:W});if(x.debug("agent:run","Processing stream",{step:S.step}),await pn(bn,S.index,ct,at,{}),ce)throw ce;let Tn=await Cn();if(de.data.response=Tn,xn.forEach(F=>{F.processed=!0}),await re(m,z.id,M),x.debug("agent:run","Waiting for action calls to complete",{pendingCalls:S.calls.length}),await Promise.allSettled(S.calls),S.calls.length=0,de.processed=!0,await re(m,z.id,M),await Promise.all(S.contexts.map(F=>F.context.onStep?.({...F,workingMemory:M},m))),await Promise.all(S.contexts.map(F=>m.saveContext(F))),S.controller.signal.aborted||!S.shouldContinue())break;S.step++}catch(q){if(await m.saveContext(z),console.error(q),await Promise.allSettled(S.contexts.map(Q=>m.saveContext(Q))),_.onError)try{await _.onError(q,{...z,workingMemory:M},m)}catch{break}else break}}return x.debug("agent:run","Marking all working memory chain as processed"),M.inputs.forEach(q=>{q.processed=!0}),S.chain.forEach(q=>{q.processed=!0}),await Promise.all(S.contexts.map(q=>q.context.onRun?.({...q,workingMemory:M},m))),await Promise.all(S.contexts.map(q=>m.saveContext(q))),x.debug("agent:run","Removing context from running set",{id:z.id}),a.delete(z.id),x.info("agent:run","Run completed",{contextId:z.id,chainLength:S.chain.length}),S.defer.resolve(S.chain),S.chain},async send(l){let _={id:U(),ref:"input",type:l.input.type,content:l.input.data,data:void 0,timestamp:Date.now(),processed:!1};return await m.run({...l,chain:l.chain?[...l.chain,_]:[_]})},async evaluator(l){let{id:_,memory:E}=l;x.debug("agent:evaluator","memory",E)},async exportAllTrainingData(l){x.info("agent:exportTrainingData","Exporting episodes as training data");let _=await m.getContexts(),E=[];for(let{id:k}of _){let I=await m.memory.vector.query(k,"");I.length>0&&E.push(...I)}x.info("agent:exportTrainingData",`Found ${E.length} episodes to export`),E.length>0?(await cn(E,l||e.trainingDataPath||"./training-data.jsonl"),x.info("agent:exportTrainingData","Episodes exported successfully")):x.warn("agent:exportTrainingData","No episodes found to export")}};return O.instance("agent",m),m}import"zod";import mr from"zod-to-json-schema";function Ya(e){return mr(e,"schema").definitions.schema}function ei(e,t){return(n,o)=>ue(e,o?o(n):t?t(n):n)}function ti(e,t){return n=>{let o=new Set(Object.keys(t));n=n.split(`
`).map(a=>{if(a.startsWith("/")){let s=a.match(/^\/([^ >]+)/);if(s&&s[1]){let i=s[1];if(o.has(i))return console.log(`fixing line:
`+a),a.replace("/","<")}}return a}).join(`
`);let r=e();return rt(n,(a,s)=>(a.type==="element"&&a.name in t&&t[a.name](r,a,s),a)),r}}var ne=class extends Error{constructor(n,o){super(n);this.message=n;this.details=o}};async function gr(e,t,n){try{let o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t,variables:n})});if(!o.ok)throw new ne(`HTTP Error: ${o.status} ${o.statusText}`,{status:o.status,statusText:o.statusText});let r=await o.json();return r.errors&&r.errors.length>0?new ne(r.errors[0].message,r.errors):r.data?r.data:new ne("No data returned from GraphQL query")}catch(o){return o instanceof ne?o:new ne("Unknown error during GraphQL fetch",o)}}var fr=1,yr={maxRetries:3,initialDelay:1e3,maxDelay:3e4,backoffFactor:2,retryableStatuses:[408,429,500,502,503,504]},De=class extends Error{constructor(n,o){super(n);this.response=o;this.name="RequestError"}},hr=e=>new Promise(t=>setTimeout(t,e)),xr=(e,t)=>{let n=t.initialDelay*Math.pow(t.backoffFactor,e-1);return Math.min(n,t.maxDelay)},br=e=>e.name==="TypeError"||e.name==="AbortError"||e instanceof De,Cr=(e,t)=>{if(!t)return e;let n=t instanceof URLSearchParams?t:new URLSearchParams(Object.entries(t).filter(([a,s])=>s!=null).map(([a,s])=>[a,String(s)])),o=e.includes("?")?"&":"?",r=n.toString();return r?`${e}${o}${r}`:e},ie={async request(e,t){let{params:n,...o}=t||{},r=Cr(e,n),a={...yr,...t?.retryOptions},s=1;for(;;)try{let i=await fetch(r,o);if(!i.ok){let c=await i.text();throw new De(`Request failed with status ${i.status}: ${c}`,i)}return i}catch(i){if(br(i)&&s<a.maxRetries){let c=xr(s,a);console.warn(`Request failed with error: ${i.message}. Retrying in ${c}ms (attempt ${s}/${a.maxRetries})`),await hr(c),s++;continue}throw i}},async json(e,t){return await(await this.request(e,{...t,headers:{"Content-Type":"application/json",...t?.headers}})).json()},get:{async request(e,t,n){return ie.request(e,{...n,method:"GET",params:t})},async json(e,t,n){return ie.json(e,{...n,method:"GET",params:t})}},post:{async request(e,t,n){return ie.request(e,{...n,method:"POST",body:JSON.stringify(t)})},async json(e,t,n){return ie.json(e,{...n,method:"POST",body:JSON.stringify(t)})}},async jsonrpc(e,t,n,o){return ie.post.json(e,{jsonrpc:"2.0",id:fr++,method:t,params:n},{headers:o})},async graphql(e,t,n,o){return ie.post.json(e,{query:t,variables:n},{headers:o})}};export{me as LogLevel,ge as Logger,Y as NotFoundError,ee as ParsingError,fe as TaskRunner,Vr as action,qe as context,dt as createContainer,le as createContextState,Ua as createDreams,Rt as createMemory,kt as createMemoryStore,ti as createParser,ei as createPrompt,mt as createServiceManager,pa as createTagParser,or as createTagRegex,_t as createVectorStore,Ln as createWorkingMemory,Dn as defaultWorkingMemory,St as deleteContext,Ur as expert,Br as extension,gr as fetchGraphQL,bt as formatAction,xe as formatContextLog,qr as formatContextLog2,Ct as formatContextState,yt as formatInput,zr as formatMsg,ht as formatOutput,xt as formatOutputInterface,dr as formatPromptSections,ye as formatSchema,he as formatValue,We as formatWorkingMemory,ze as formatXml,be as getContextId,vt as getContextWorkingMemory,wt as getContexts,Ve as getPathSegments,It as getValueByPath,os as getWorkingMemoryAllLogs,jn as getWorkingMemoryLogs,Ya as getZodJsonSchema,Mt as handleActionCall,Nt as handleInput,jt as handleOutput,ie as http,Zr as input,da as isElement,ma as isText,Ce as loadContextState,Le as mainStep,En as memory,je as modelsResponseConfig,Hr as output,rt as parse,ot as parseAttributes,Lt as prepareAction,Et as prepareActionCall,Dt as prepareContext,Pt as prepareContextActions,st as promptTemplate,Tt as pushToWorkingMemory,U as randomUUIDv7,ur as reasoningModels,ue as render,Te as resolvePathSegments,Ot as resolveTemplates,$t as runAction,gn as runGenerate,At as saveContextState,re as saveContextWorkingMemory,Fe as saveContextsIndex,Er as service,Jr as splitTextIntoChunks,$e as task,pr as templateSections,Kr as trimWorkingMemory,oe as tryAsync,Gr as validateEnv,D as xml,ln as xmlStreamParser};
//# sourceMappingURL=index.js.map